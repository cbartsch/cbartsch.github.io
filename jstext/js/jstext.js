function formatText(text){return text.replace(/%n/g,"<br/>")}var module=angular.module("jstext.game",["jstext.prediction"]);module.constant("WITH_SEPARATOR"," with "),module.constant("getOrDefault",function(value,defaultValue){return"undefined"!=typeof value?value:defaultValue}),module.factory("Actions",["getOrDefault",function(getOrDefault){return{enable:function(gameState,action,entity){entity.enabled=getOrDefault(action.value,!entity.enabled)},remove:function(gameState,action,entity){entity.remove()},state:function(gameState,action,entity){entity.state=action.value},take:function(gameState,action,entity){entity.remove(),gameState.inventory.add(entity)},visible:function(gameState,action,entity){entity.visible=getOrDefault(action.value,!entity.visible)},win:function(gameState,action,entity){gameState.win()}}}]),module.constant("Conditions",{state:function(gameState,condition,entity){return entity.state===condition.value},item:function(gameState,condition,entity){return entity.name in gameState.inventory.objects}}),module.factory("EntityCommand",["Actions","Conditions","WITH_SEPARATOR",function(actions,conditions,WITH_SEPARATOR){return function(gameState,cmd,cmdKey,param){var entityName,withItemName,withIndex=param.indexOf(WITH_SEPARATOR);withIndex>=0?(entityName=param.substr(withIndex+WITH_SEPARATOR.length),withItemName=param.substr(0,withIndex)):(entityName=param,withItemName=null);var current=gameState.location,entity=0==entityName.length?current:current.objects[entityName];if(!withItemName||withItemName in gameState.inventory.objects)if(entity&&entity.visible)if(entity.enabled){var action=entity[withItemName?cmdKey+"_with":cmdKey];if(action)if(withItemName&&withItemName!==action.item)gameState.print("Can not use "+withItemName+" with this.");else{var conditionMet=!0;action["if"]&&action["if"].forEach(function(condition){var conditionFunc=conditions[condition.type];if(conditionFunc){var targets=condition.targets||[entity.name];conditionMet=targets.every(function(targetId){var entity=gameState.allEntities[targetId],result=conditionFunc(gameState,condition,entity);return result||gameState.print(condition["else"]),result})}}),conditionMet&&(action.text&&gameState.print(action.text),action["do"]&&action["do"].forEach(function(doAction){var actionFunc=actions[doAction.type];if(actionFunc){var targets=doAction.targets||[entity.name];targets.forEach(function(targetId){var entity=gameState.allEntities[targetId];actionFunc(gameState,doAction,entity)})}}))}else gameState.print("Not possible.")}else gameState.print("Not possible right now.");else gameState.print("Can not "+cmd+": "+entityName+" not found");else gameState.print(withItemName+" not in inventory.")}}]),module.factory("GoCommand",[function(){return function(gameState,cmd,cmdKey,param){var locationName=param;if(locationName){var location=gameState.allEntities[locationName];location&&location.visible?location===gameState.location?gameState.print("You are already at "+locationName):!location.enabled||gameState.location.adjacent.indexOf(location.name)<0?gameState.print("Can not go to "+location.name):(gameState.location=location,gameState.print("You are now at: "+location.name)):gameState.print(locationName+" not found. Can not go.")}else gameState.print("Where to go to?")}}]),module.factory("HelpCommand",[function(){function helpCmd(gameState,cmd,cmdKey,param){gameState.print("Available commands: "+helpCmd.interactions.map(function(interaction){return interaction.cmds[0]}).join(", ")+".")}return helpCmd.interactions=[],helpCmd}]),module.service("Interaction",[function(){return function(cmds,cmdKey,command){this.cmds=cmds,this["do"]=function(gameState,cmd,param){command(gameState,cmd,cmdKey,param)}}}]),module.factory("Interactions",["Interaction","EntityCommand","GoCommand","HelpCommand",function(Interaction,EntityCommand,GoCommand,HelpCommand){var interactions=[new Interaction(["use"],"use",EntityCommand),new Interaction(["take","pick up"],"take",EntityCommand),new Interaction(["look at","look","inspect"],"look",EntityCommand),new Interaction(["go to","walk to","go","walk","cd"],"go",GoCommand),new Interaction(["help","?"],"",HelpCommand)];return HelpCommand.interactions=interactions,interactions.forCmd=function(cmd){var usedCmd="",matches=$.grep(interactions,function(interaction){return interaction.cmds.some(function(iCmd){return cmd.substr(0,iCmd.length)!==iCmd||cmd.length!=iCmd.length&&" "!=cmd[iCmd.length]?!1:(usedCmd=iCmd,!0)})}),interaction=matches.length>0?matches[0]:null,param=cmd.substr(usedCmd.length).trim();return{"do":function(gameState){return interaction&&interaction["do"](gameState,usedCmd,param),this},"else":function(callback){interaction||callback()}}},interactions}]),module.service("Entity",["getOrDefault",function(getOrDefault){return function(name,model,parent){this.name=name,this.parent=parent,this.text=model.text,this.imageUrl=model.imageUrl,this.visible=getOrDefault(model.visible,!0),this.enabled=getOrDefault(model.enabled,!0),this.state=model.state||"",this.use=model.use||null,this.use_with=model.use_with||null,this.take=model.take||null,this.look=model.look||null,this.objects=model.objects||{},this.adjacent=model.adjacent||[],this.remove=function(){this.parent&&this.name in this.parent.objects&&delete this.parent.objects[this.name]},this.add=function(entity){this.objects[entity.name]=entity,entity.parent=this}}}]),module.factory("buildEntityMap",["Entity",function(Entity){return function(model){var allEntities={};for(var key in model.locations){var loc=model.locations[key],locEntity=new Entity(key,loc,null);allEntities[key]=locEntity;for(var objKey in loc.objects)allEntities[objKey]=new Entity(objKey,loc.objects[objKey],locEntity)}return Object.keys(allEntities).forEach(function(name){var entity=allEntities[name],objectModel=entity.objects;entity.objects={},Object.keys(objectModel).forEach(function(objName){entity.objects[objName]=allEntities[objName]})}),allEntities}}]),module.service("GameState",["buildEntityMap","Entity","Interactions","PredictionService",function(buildEntityMap,Entity,interactions,predictionService){return function(game,printer,winCallback){var gameState=this;this.game=game,this.print=printer,this.predictionService=predictionService,this.allEntities=buildEntityMap(game.model),this.location=this.allEntities[game.startLocationName],this.inventory=new Entity("inventory",{},null),this.print(game.startText),this.win=function(){this.print("YOU WIN THE GAME"),winCallback()},this.commandList=[],interactions.forEach(function(interaction){gameState.commandList.push.apply(gameState.commandList,interaction.cmds)}),this.enter=function(text){var trimmedText=text.trim();interactions.forCmd(trimmedText)["do"](this)["else"](function(){var prediction=predictionService.findClosestElement(trimmedText,gameState.commandList);gameState.print(prediction?"Did you mean "+prediction+"?":"I don't understand '"+trimmedText+"'.")})}}}]),module.service("Game",["GameState",function(GameState){return function(model){this.startLocationName=model.start,this.startText=model.start_text,this.model=model,this.start=function(printer,winCallback){return new GameState(this,printer,winCallback)}}}]);var jstext=angular.module("jstext",["ngSanitize","luegg.directives","jstext.prediction","jstext.game"]);jstext.controller("GameController",["$scope","$http","Game",function($scope,$http,Game){$scope.restart=function(){$scope.log=[],$scope.gameState=$scope.game.start($scope.print,$scope.onWin),$scope.inventory=$scope.gameState.inventory.objects},$scope.onWin=function(){},$http.get("game/test.json").then(function(result){$scope.game=new Game(result.data),$scope.restart(),$scope.updateLocation()}),$scope.updateLocation=function(){$scope.location=$scope.gameState?{text:formatText($scope.gameState.location.text),image:$scope.gameState.location.imageUrl||"http://www.theodora.com/maps/new9/time_zones_4.jpg"}:{}},$scope.updateLocation();var addLog=function(text,type){$scope.log.push({index:$scope.log.length,text:text,type:type})};$scope.print=function(text){addLog(formatText(text),"output")},$scope.input="",$scope.command=function(){addLog($scope.input,"input");var input=$scope.input.toLowerCase();"restart"===input?$scope.restart():($scope.gameState.enter(input),$scope.updateLocation()),$scope.input=""},$scope.useItem=function(name){$scope.input="use "+name+" with ",setTimeout(function(){$("#inputfield").focus()},1)}}]);var prediction=angular.module("jstext.prediction",[]);prediction.constant("HAMMING_THRESHOLD",4),prediction.factory("PredictionService",["HAMMING_THRESHOLD",function(HAMMING_THRESHOLD){var service={};return service.findClosestElement=function(element,haystack){this.findHammingDistance=function(a,b){for(var firstIsShorter=a.length<=b.length,shorter=(firstIsShorter?a:b).toLowerCase(),longer=(firstIsShorter?b:a).toLowerCase(),hammingDistance=0,i=0;i<longer.length;i++)shorter.length===i&&(shorter+=" "),shorter.charAt(i)!==longer.charAt(i)&&(hammingDistance+=1);return hammingDistance};var foundEle,minDistance=Number.MAX_VALUE,closestElement=null;for(var i in haystack){var test=haystack[i];if(!(test.length<2)){var currentEle=element;currentEle.length>test.length&&(currentEle=currentEle.substr(0,test.length));var currentDistance=this.findHammingDistance(currentEle,test);minDistance>currentDistance&&(minDistance=currentDistance,closestElement=test,foundEle=currentEle)}}var threshold=Math.min(HAMMING_THRESHOLD,foundEle.length-1);return threshold>=minDistance?closestElement:null},service}]);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpzdGV4dC5qcyIsImdhbWUuanMiLCJwcmVkaWN0aW9uU2VydmljZS5qcyJdLCJuYW1lcyI6WyJmb3JtYXRUZXh0IiwidGV4dCIsInJlcGxhY2UiLCJtb2R1bGUiLCJhbmd1bGFyIiwiY29uc3RhbnQiLCJ2YWx1ZSIsImRlZmF1bHRWYWx1ZSIsImZhY3RvcnkiLCJnZXRPckRlZmF1bHQiLCJlbmFibGUiLCJnYW1lU3RhdGUiLCJhY3Rpb24iLCJlbnRpdHkiLCJlbmFibGVkIiwicmVtb3ZlIiwic3RhdGUiLCJ0YWtlIiwiaW52ZW50b3J5IiwiYWRkIiwidmlzaWJsZSIsIndpbiIsImNvbmRpdGlvbiIsIml0ZW0iLCJuYW1lIiwib2JqZWN0cyIsImFjdGlvbnMiLCJjb25kaXRpb25zIiwiV0lUSF9TRVBBUkFUT1IiLCJjbWQiLCJjbWRLZXkiLCJwYXJhbSIsImVudGl0eU5hbWUiLCJ3aXRoSXRlbU5hbWUiLCJ3aXRoSW5kZXgiLCJpbmRleE9mIiwic3Vic3RyIiwibGVuZ3RoIiwiY3VycmVudCIsImxvY2F0aW9uIiwicHJpbnQiLCJjb25kaXRpb25NZXQiLCJmb3JFYWNoIiwiY29uZGl0aW9uRnVuYyIsInR5cGUiLCJ0YXJnZXRzIiwiZXZlcnkiLCJ0YXJnZXRJZCIsImFsbEVudGl0aWVzIiwicmVzdWx0IiwiZG9BY3Rpb24iLCJhY3Rpb25GdW5jIiwibG9jYXRpb25OYW1lIiwiYWRqYWNlbnQiLCJoZWxwQ21kIiwiaW50ZXJhY3Rpb25zIiwibWFwIiwiaW50ZXJhY3Rpb24iLCJjbWRzIiwiam9pbiIsInNlcnZpY2UiLCJjb21tYW5kIiwidGhpcyIsIkludGVyYWN0aW9uIiwiRW50aXR5Q29tbWFuZCIsIkdvQ29tbWFuZCIsIkhlbHBDb21tYW5kIiwiZm9yQ21kIiwidXNlZENtZCIsIm1hdGNoZXMiLCIkIiwiZ3JlcCIsInNvbWUiLCJpQ21kIiwidHJpbSIsImRvIiwiZWxzZSIsImNhbGxiYWNrIiwibW9kZWwiLCJwYXJlbnQiLCJpbWFnZVVybCIsInVzZSIsInVzZV93aXRoIiwibG9vayIsIkVudGl0eSIsImtleSIsImxvY2F0aW9ucyIsImxvYyIsImxvY0VudGl0eSIsIm9iaktleSIsIk9iamVjdCIsImtleXMiLCJvYmplY3RNb2RlbCIsIm9iak5hbWUiLCJidWlsZEVudGl0eU1hcCIsInByZWRpY3Rpb25TZXJ2aWNlIiwiZ2FtZSIsInByaW50ZXIiLCJ3aW5DYWxsYmFjayIsInN0YXJ0TG9jYXRpb25OYW1lIiwic3RhcnRUZXh0IiwiY29tbWFuZExpc3QiLCJwdXNoIiwiYXBwbHkiLCJlbnRlciIsInRyaW1tZWRUZXh0IiwicHJlZGljdGlvbiIsImZpbmRDbG9zZXN0RWxlbWVudCIsIkdhbWVTdGF0ZSIsInN0YXJ0Iiwic3RhcnRfdGV4dCIsImpzdGV4dCIsImNvbnRyb2xsZXIiLCIkc2NvcGUiLCIkaHR0cCIsIkdhbWUiLCJyZXN0YXJ0IiwibG9nIiwib25XaW4iLCJnZXQiLCJ0aGVuIiwiZGF0YSIsInVwZGF0ZUxvY2F0aW9uIiwiaW1hZ2UiLCJhZGRMb2ciLCJpbmRleCIsImlucHV0IiwidG9Mb3dlckNhc2UiLCJ1c2VJdGVtIiwic2V0VGltZW91dCIsImZvY3VzIiwiSEFNTUlOR19USFJFU0hPTEQiLCJlbGVtZW50IiwiaGF5c3RhY2siLCJmaW5kSGFtbWluZ0Rpc3RhbmNlIiwiYSIsImIiLCJmaXJzdElzU2hvcnRlciIsInNob3J0ZXIiLCJsb25nZXIiLCJoYW1taW5nRGlzdGFuY2UiLCJpIiwiY2hhckF0IiwiZm91bmRFbGUiLCJtaW5EaXN0YW5jZSIsIk51bWJlciIsIk1BWF9WQUxVRSIsImNsb3Nlc3RFbGVtZW50IiwidGVzdCIsImN1cnJlbnRFbGUiLCJjdXJyZW50RGlzdGFuY2UiLCJ0aHJlc2hvbGQiLCJNYXRoIiwibWluIl0sIm1hcHBpbmdzIjoiQUFHQSxRQUFBQSxZQUFBQyxNQUNBLE1BQUFBLE1BQUFDLFFBQUEsTUFBQSxTQ0FBLEdBQUFDLFFBQUFDLFFBQUFELE9BQUEsZUFBQSxxQkFFQUEsUUFBQUUsU0FBQSxpQkFBQSxVQUVBRixP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UUFBQXJHLFNBQUF3RyxJQUFBSCxTQUFBLEtBQ0FBLFFBQUFJLE9BQUFELEtBQUFGLE9BQUFHLE9BQUFELEtBQ0FELGlCQUFBLEVBSUEsT0FBQUEsaUJBR0EsSUFFQUcsVUFGQUMsWUFBQUMsT0FBQUMsVUFDQUMsZUFBQSxJQUVBLEtBQUEsR0FBQU4sS0FBQVIsVUFBQSxDQUNBLEdBQUFlLE1BQUFmLFNBQUFRLEVBQ0EsTUFBQU8sS0FBQS9HLE9BQUEsR0FBQSxDQUdBLEdBQUFnSCxZQUFBakIsT0FDQWlCLFlBQUFoSCxPQUFBK0csS0FBQS9HLFNBQ0FnSCxXQUFBQSxXQUFBakgsT0FBQSxFQUFBZ0gsS0FBQS9HLFFBRUEsSUFBQWlILGlCQUFBeEYsS0FBQXdFLG9CQUFBZSxXQUFBRCxLQUNBSixhQUFBTSxrQkFDQU4sWUFBQU0sZ0JBQ0FILGVBQUFDLEtBQ0FMLFNBQUFNLGFBTUEsR0FBQUUsV0FBQUMsS0FBQUMsSUFBQXRCLGtCQUFBWSxTQUFBMUcsT0FBQSxFQUNBLE9BQUFrSCxZQUFBUCxZQUFBRyxlQUFBLE1BR0F2RiIsImZpbGUiOiJqc3RleHQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcclxuXHJcbnZhciBqc3RleHQgPSBhbmd1bGFyLm1vZHVsZShcImpzdGV4dFwiLCBbXCJuZ1Nhbml0aXplXCIsIFwibHVlZ2cuZGlyZWN0aXZlc1wiLCBcImpzdGV4dC5wcmVkaWN0aW9uXCIsIFwianN0ZXh0LmdhbWVcIl0pO1xyXG5mdW5jdGlvbiBmb3JtYXRUZXh0KHRleHQpIHtcclxuICAgIHJldHVybiB0ZXh0LnJlcGxhY2UoLyVuL2csIFwiPGJyLz5cIik7XHJcbn1cclxuXHJcbmpzdGV4dC5jb250cm9sbGVyKFwiR2FtZUNvbnRyb2xsZXJcIiwgW1wiJHNjb3BlXCIsIFwiJGh0dHBcIiwgXCJHYW1lXCIsIGZ1bmN0aW9uICgkc2NvcGUsICRodHRwLCBHYW1lKSB7XHJcblxyXG4gICAgJHNjb3BlLnJlc3RhcnQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgJHNjb3BlLmxvZyA9IFtdO1xyXG4gICAgICAgICRzY29wZS5nYW1lU3RhdGUgPSAkc2NvcGUuZ2FtZS5zdGFydCgkc2NvcGUucHJpbnQsICRzY29wZS5vbldpbik7XHJcbiAgICAgICAgJHNjb3BlLmludmVudG9yeSA9ICRzY29wZS5nYW1lU3RhdGUuaW52ZW50b3J5Lm9iamVjdHM7XHJcbiAgICB9O1xyXG5cclxuICAgICRzY29wZS5vbldpbiA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgIC8vICRzY29wZS5yZXN0YXJ0KCk7XHJcbiAgICB9O1xyXG5cclxuICAgICRodHRwLmdldChcImdhbWUvdGVzdC5qc29uXCIpLnRoZW4oZnVuY3Rpb24gKHJlc3VsdCkge1xyXG4gICAgICAgICRzY29wZS5nYW1lID0gbmV3IEdhbWUocmVzdWx0LmRhdGEpO1xyXG4gICAgICAgICRzY29wZS5yZXN0YXJ0KCk7XHJcbiAgICAgICAgJHNjb3BlLnVwZGF0ZUxvY2F0aW9uKCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICAkc2NvcGUudXBkYXRlTG9jYXRpb24gPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgJHNjb3BlLmxvY2F0aW9uID0gJHNjb3BlLmdhbWVTdGF0ZSA/IHtcclxuICAgICAgICAgICAgdGV4dDogZm9ybWF0VGV4dCgkc2NvcGUuZ2FtZVN0YXRlLmxvY2F0aW9uLnRleHQpLFxyXG4gICAgICAgICAgICBpbWFnZTogJHNjb3BlLmdhbWVTdGF0ZS5sb2NhdGlvbi5pbWFnZVVybCB8fCBcImh0dHA6Ly93d3cudGhlb2RvcmEuY29tL21hcHMvbmV3OS90aW1lX3pvbmVzXzQuanBnXCJcclxuICAgICAgICB9IDoge307XHJcbiAgICB9O1xyXG4gICAgJHNjb3BlLnVwZGF0ZUxvY2F0aW9uKCk7XHJcblxyXG4gICAgdmFyIGFkZExvZyA9IGZ1bmN0aW9uKHRleHQsIHR5cGUpIHtcclxuICAgICAgICAkc2NvcGUubG9nLnB1c2goe1xyXG4gICAgICAgICAgICBpbmRleDogJHNjb3BlLmxvZy5sZW5ndGgsXHJcbiAgICAgICAgICAgIHRleHQ6IHRleHQsXHJcbiAgICAgICAgICAgIHR5cGU6IHR5cGVcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgJHNjb3BlLnByaW50ID0gZnVuY3Rpb24gKHRleHQpIHtcclxuICAgICAgICBhZGRMb2coZm9ybWF0VGV4dCh0ZXh0KSwgXCJvdXRwdXRcIik7XHJcbiAgICB9O1xyXG5cclxuICAgICRzY29wZS5pbnB1dCA9IFwiXCI7XHJcbiAgICAkc2NvcGUuY29tbWFuZCA9IGZ1bmN0aW9uIGNvbW1hbmQoKSB7XHJcbiAgICAgICAgYWRkTG9nKCRzY29wZS5pbnB1dCwgXCJpbnB1dFwiKTtcclxuICAgICAgICB2YXIgaW5wdXQgPSAkc2NvcGUuaW5wdXQudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICBpZiAoaW5wdXQgPT09IFwicmVzdGFydFwiKSB7XHJcbiAgICAgICAgICAgICRzY29wZS5yZXN0YXJ0KCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgJHNjb3BlLmdhbWVTdGF0ZS5lbnRlcihpbnB1dCk7XHJcbiAgICAgICAgICAgICRzY29wZS51cGRhdGVMb2NhdGlvbigpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAkc2NvcGUuaW5wdXQgPSBcIlwiO1xyXG4gICAgfTtcclxuXHJcbiAgICAkc2NvcGUudXNlSXRlbSA9IGZ1bmN0aW9uKG5hbWUpIHtcclxuICAgICAgICAkc2NvcGUuaW5wdXQgPSBcInVzZSBcIiArIG5hbWUgKyBcIiB3aXRoIFwiO1xyXG4gICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7ICQoXCIjaW5wdXRmaWVsZFwiKS5mb2N1cygpIH0sIDEpO1xyXG4gICAgfVxyXG59XSk7IiwiLyoqXHJcbiAqIENyZWF0ZWQgYnkgQ2hyaXN1IG9uIDI2LjA1LjIwMTUuXHJcbiAqL1xyXG5cclxudmFyIG1vZHVsZSA9IGFuZ3VsYXIubW9kdWxlKFwianN0ZXh0LmdhbWVcIiwgW1wianN0ZXh0LnByZWRpY3Rpb25cIl0pO1xyXG5cclxubW9kdWxlLmNvbnN0YW50KFwiV0lUSF9TRVBBUkFUT1JcIiwgXCIgd2l0aCBcIik7XHJcblxyXG5tb2R1bGUuY29uc3RhbnQoXCJnZXRPckRlZmF1bHRcIiwgZnVuY3Rpb24gKHZhbHVlLCBkZWZhdWx0VmFsdWUpIHtcclxuICAgIHJldHVybiB0eXBlb2YgdmFsdWUgIT09IFwidW5kZWZpbmVkXCIgPyB2YWx1ZSA6IGRlZmF1bHRWYWx1ZTtcclxufSk7XHJcblxyXG5tb2R1bGUuZmFjdG9yeShcIkFjdGlvbnNcIiwgW1wiZ2V0T3JEZWZhdWx0XCIsIGZ1bmN0aW9uIChnZXRPckRlZmF1bHQpIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgZW5hYmxlOiBmdW5jdGlvbiAoZ2FtZVN0YXRlLCBhY3Rpb24sIGVudGl0eSkge1xyXG4gICAgICAgICAgICBlbnRpdHkuZW5hYmxlZCA9IGdldE9yRGVmYXVsdChhY3Rpb24udmFsdWUsICFlbnRpdHkuZW5hYmxlZCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICByZW1vdmU6IGZ1bmN0aW9uIChnYW1lU3RhdGUsIGFjdGlvbiwgZW50aXR5KSB7XHJcbiAgICAgICAgICAgIGVudGl0eS5yZW1vdmUoKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHN0YXRlOiBmdW5jdGlvbiAoZ2FtZVN0YXRlLCBhY3Rpb24sIGVudGl0eSkge1xyXG4gICAgICAgICAgICBlbnRpdHkuc3RhdGUgPSBhY3Rpb24udmFsdWU7XHJcbiAgICAgICAgfSxcclxuICAgICAgICB0YWtlOiBmdW5jdGlvbiAoZ2FtZVN0YXRlLCBhY3Rpb24sIGVudGl0eSkge1xyXG4gICAgICAgICAgICBlbnRpdHkucmVtb3ZlKCk7XHJcbiAgICAgICAgICAgIGdhbWVTdGF0ZS5pbnZlbnRvcnkuYWRkKGVudGl0eSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICB2aXNpYmxlOiBmdW5jdGlvbiAoZ2FtZVN0YXRlLCBhY3Rpb24sIGVudGl0eSkge1xyXG4gICAgICAgICAgICBlbnRpdHkudmlzaWJsZSA9IGdldE9yRGVmYXVsdChhY3Rpb24udmFsdWUsICFlbnRpdHkudmlzaWJsZSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICB3aW46IGZ1bmN0aW9uIChnYW1lU3RhdGUsIGFjdGlvbiwgZW50aXR5KSB7XHJcbiAgICAgICAgICAgIGdhbWVTdGF0ZS53aW4oKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1dKTtcclxuXHJcbm1vZHVsZS5jb25zdGFudChcIkNvbmRpdGlvbnNcIiwge1xyXG4gICAgc3RhdGU6IGZ1bmN0aW9uIChnYW1lU3RhdGUsIGNvbmRpdGlvbiwgZW50aXR5KSB7XHJcbiAgICAgICAgcmV0dXJuIGVudGl0eS5zdGF0ZSA9PT0gY29uZGl0aW9uLnZhbHVlO1xyXG4gICAgfSxcclxuICAgIGl0ZW06IGZ1bmN0aW9uIChnYW1lU3RhdGUsIGNvbmRpdGlvbiwgZW50aXR5KSB7XHJcbiAgICAgICAgcmV0dXJuIGVudGl0eS5uYW1lIGluIGdhbWVTdGF0ZS5pbnZlbnRvcnkub2JqZWN0cztcclxuICAgIH1cclxufSk7XHJcblxyXG5tb2R1bGUuZmFjdG9yeShcIkVudGl0eUNvbW1hbmRcIiwgW1wiQWN0aW9uc1wiLCBcIkNvbmRpdGlvbnNcIiwgXCJXSVRIX1NFUEFSQVRPUlwiLFxyXG4gICAgZnVuY3Rpb24gKGFjdGlvbnMsIGNvbmRpdGlvbnMsIFdJVEhfU0VQQVJBVE9SKSB7XHJcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChnYW1lU3RhdGUsIGNtZCwgY21kS2V5LCBwYXJhbSkge1xyXG4gICAgICAgICAgICB2YXIgd2l0aEluZGV4ID0gcGFyYW0uaW5kZXhPZihXSVRIX1NFUEFSQVRPUik7XHJcbiAgICAgICAgICAgIHZhciBlbnRpdHlOYW1lLCB3aXRoSXRlbU5hbWU7XHJcbiAgICAgICAgICAgIGlmICh3aXRoSW5kZXggPj0gMCkge1xyXG4gICAgICAgICAgICAgICAgZW50aXR5TmFtZSA9IHBhcmFtLnN1YnN0cih3aXRoSW5kZXggKyBXSVRIX1NFUEFSQVRPUi5sZW5ndGgpO1xyXG4gICAgICAgICAgICAgICAgd2l0aEl0ZW1OYW1lID0gcGFyYW0uc3Vic3RyKDAsIHdpdGhJbmRleCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBlbnRpdHlOYW1lID0gcGFyYW07XHJcbiAgICAgICAgICAgICAgICB3aXRoSXRlbU5hbWUgPSBudWxsO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB2YXIgY3VycmVudCA9IGdhbWVTdGF0ZS5sb2NhdGlvbjtcclxuICAgICAgICAgICAgdmFyIGVudGl0eSA9IGVudGl0eU5hbWUubGVuZ3RoID09IDBcclxuICAgICAgICAgICAgICAgID8gY3VycmVudCA6IGN1cnJlbnQub2JqZWN0c1tlbnRpdHlOYW1lXTtcclxuXHJcbiAgICAgICAgICAgIGlmICh3aXRoSXRlbU5hbWUgJiYgISh3aXRoSXRlbU5hbWUgaW4gZ2FtZVN0YXRlLmludmVudG9yeS5vYmplY3RzKSkge1xyXG4gICAgICAgICAgICAgICAgZ2FtZVN0YXRlLnByaW50KHdpdGhJdGVtTmFtZSArIFwiIG5vdCBpbiBpbnZlbnRvcnkuXCIpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKCFlbnRpdHkgfHwgIWVudGl0eS52aXNpYmxlKSB7XHJcbiAgICAgICAgICAgICAgICBnYW1lU3RhdGUucHJpbnQoXCJDYW4gbm90IFwiICsgY21kICsgXCI6IFwiICsgZW50aXR5TmFtZSArIFwiIG5vdCBmb3VuZFwiKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmICghZW50aXR5LmVuYWJsZWQpIHtcclxuICAgICAgICAgICAgICAgIGdhbWVTdGF0ZS5wcmludChcIk5vdCBwb3NzaWJsZSByaWdodCBub3cuXCIpXHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgYWN0aW9uID0gZW50aXR5W3dpdGhJdGVtTmFtZSA/IGNtZEtleSArIFwiX3dpdGhcIiA6IGNtZEtleV07XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKCFhY3Rpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICBnYW1lU3RhdGUucHJpbnQoXCJOb3QgcG9zc2libGUuXCIpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh3aXRoSXRlbU5hbWUgJiYgd2l0aEl0ZW1OYW1lICE9PSBhY3Rpb24uaXRlbSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGdhbWVTdGF0ZS5wcmludChcIkNhbiBub3QgdXNlIFwiICsgd2l0aEl0ZW1OYW1lICsgXCIgd2l0aCB0aGlzLlwiKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbmRpdGlvbk1ldCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGlvbi5pZikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb24uaWYuZm9yRWFjaChmdW5jdGlvbiAoY29uZGl0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29uZGl0aW9uRnVuYyA9IGNvbmRpdGlvbnNbY29uZGl0aW9uLnR5cGVdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmRpdGlvbkZ1bmMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0cyA9IGNvbmRpdGlvbi50YXJnZXRzIHx8IFtlbnRpdHkubmFtZV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZGl0aW9uTWV0ID0gdGFyZ2V0cy5ldmVyeShmdW5jdGlvbiAodGFyZ2V0SWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVudGl0eSA9IGdhbWVTdGF0ZS5hbGxFbnRpdGllc1t0YXJnZXRJZF07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBjb25kaXRpb25GdW5jKGdhbWVTdGF0ZSwgY29uZGl0aW9uLCBlbnRpdHkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlc3VsdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZVN0YXRlLnByaW50KGNvbmRpdGlvbi5lbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmRpdGlvbk1ldCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWN0aW9uLnRleHQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhbWVTdGF0ZS5wcmludChhY3Rpb24udGV4dCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGlvbi5kbykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uLmRvLmZvckVhY2goZnVuY3Rpb24gKGRvQWN0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFjdGlvbkZ1bmMgPSBhY3Rpb25zW2RvQWN0aW9uLnR5cGVdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhY3Rpb25GdW5jKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0YXJnZXRzID0gZG9BY3Rpb24udGFyZ2V0cyB8fCBbZW50aXR5Lm5hbWVdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRzLmZvckVhY2goZnVuY3Rpb24gKHRhcmdldElkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZW50aXR5ID0gZ2FtZVN0YXRlLmFsbEVudGl0aWVzW3RhcmdldElkXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbkZ1bmMoZ2FtZVN0YXRlLCBkb0FjdGlvbiwgZW50aXR5KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XSk7XHJcblxyXG5tb2R1bGUuZmFjdG9yeShcIkdvQ29tbWFuZFwiLCBbZnVuY3Rpb24gKCkge1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChnYW1lU3RhdGUsIGNtZCwgY21kS2V5LCBwYXJhbSkge1xyXG4gICAgICAgIHZhciBsb2NhdGlvbk5hbWUgPSBwYXJhbTtcclxuICAgICAgICBpZiAoIWxvY2F0aW9uTmFtZSkge1xyXG4gICAgICAgICAgICBnYW1lU3RhdGUucHJpbnQoXCJXaGVyZSB0byBnbyB0bz9cIik7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdmFyIGxvY2F0aW9uID0gZ2FtZVN0YXRlLmFsbEVudGl0aWVzW2xvY2F0aW9uTmFtZV07XHJcbiAgICAgICAgICAgIGlmICghbG9jYXRpb24gfHwgIWxvY2F0aW9uLnZpc2libGUpIHtcclxuICAgICAgICAgICAgICAgIGdhbWVTdGF0ZS5wcmludChsb2NhdGlvbk5hbWUgKyBcIiBub3QgZm91bmQuIENhbiBub3QgZ28uXCIpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGxvY2F0aW9uID09PSBnYW1lU3RhdGUubG9jYXRpb24pIHtcclxuICAgICAgICAgICAgICAgIGdhbWVTdGF0ZS5wcmludChcIllvdSBhcmUgYWxyZWFkeSBhdCBcIiArIGxvY2F0aW9uTmFtZSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWxvY2F0aW9uLmVuYWJsZWQgfHwgZ2FtZVN0YXRlLmxvY2F0aW9uLmFkamFjZW50LmluZGV4T2YobG9jYXRpb24ubmFtZSkgPCAwKSB7XHJcbiAgICAgICAgICAgICAgICBnYW1lU3RhdGUucHJpbnQoXCJDYW4gbm90IGdvIHRvIFwiICsgbG9jYXRpb24ubmFtZSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBnYW1lU3RhdGUubG9jYXRpb24gPSBsb2NhdGlvbjtcclxuICAgICAgICAgICAgICAgIGdhbWVTdGF0ZS5wcmludChcIllvdSBhcmUgbm93IGF0OiBcIiArIGxvY2F0aW9uLm5hbWUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XSk7XHJcblxyXG5tb2R1bGUuZmFjdG9yeShcIkhlbHBDb21tYW5kXCIsIFtmdW5jdGlvbiAoKSB7XHJcbiAgICBmdW5jdGlvbiBoZWxwQ21kKGdhbWVTdGF0ZSwgY21kLCBjbWRLZXksIHBhcmFtKSB7XHJcbiAgICAgICAgZ2FtZVN0YXRlLnByaW50KFwiQXZhaWxhYmxlIGNvbW1hbmRzOiBcIiArIGhlbHBDbWQuaW50ZXJhY3Rpb25zLm1hcChmdW5jdGlvbiAoaW50ZXJhY3Rpb24pIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBpbnRlcmFjdGlvbi5jbWRzWzBdO1xyXG4gICAgICAgICAgICB9KS5qb2luKFwiLCBcIikgKyBcIi5cIik7XHJcbiAgICB9XHJcblxyXG4gICAgLy9jYW4gbm90IGhhdmUgZGVwZW5kZW5jeSB0byBJbnRlcmFjdGlvbnMsIHdvdWxkIGJlIGEgY3ljbGljIGRlcGVuZGVuY3lcclxuICAgIC8vd2lsbCBiZSBzZXQgbGF0ZXIgaW4gSW50ZXJhY3Rpb24gZmFjdG9yeVxyXG4gICAgaGVscENtZC5pbnRlcmFjdGlvbnMgPSBbXTtcclxuICAgIHJldHVybiBoZWxwQ21kO1xyXG59XSk7XHJcblxyXG5tb2R1bGUuc2VydmljZShcIkludGVyYWN0aW9uXCIsIFtmdW5jdGlvbiAoKSB7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGNtZHMsIGNtZEtleSwgY29tbWFuZCkge1xyXG4gICAgICAgIHRoaXMuY21kcyA9IGNtZHM7XHJcbiAgICAgICAgdGhpcy5kbyA9IGZ1bmN0aW9uIChnYW1lU3RhdGUsIGNtZCwgcGFyYW0pIHtcclxuICAgICAgICAgICAgY29tbWFuZChnYW1lU3RhdGUsIGNtZCwgY21kS2V5LCBwYXJhbSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxufV0pO1xyXG5cclxubW9kdWxlLmZhY3RvcnkoXCJJbnRlcmFjdGlvbnNcIiwgW1wiSW50ZXJhY3Rpb25cIiwgXCJFbnRpdHlDb21tYW5kXCIsIFwiR29Db21tYW5kXCIsIFwiSGVscENvbW1hbmRcIixcclxuICAgIGZ1bmN0aW9uIChJbnRlcmFjdGlvbiwgRW50aXR5Q29tbWFuZCwgR29Db21tYW5kLCBIZWxwQ29tbWFuZCkge1xyXG4gICAgICAgIHZhciBpbnRlcmFjdGlvbnMgPSBbXHJcbiAgICAgICAgICAgIG5ldyBJbnRlcmFjdGlvbihbXCJ1c2VcIl0sIFwidXNlXCIsIEVudGl0eUNvbW1hbmQpLFxyXG4gICAgICAgICAgICBuZXcgSW50ZXJhY3Rpb24oW1widGFrZVwiLCBcInBpY2sgdXBcIl0sIFwidGFrZVwiLCBFbnRpdHlDb21tYW5kKSxcclxuICAgICAgICAgICAgbmV3IEludGVyYWN0aW9uKFtcImxvb2sgYXRcIiwgXCJsb29rXCIsIFwiaW5zcGVjdFwiXSwgXCJsb29rXCIsIEVudGl0eUNvbW1hbmQpLFxyXG4gICAgICAgICAgICBuZXcgSW50ZXJhY3Rpb24oW1wiZ28gdG9cIiwgXCJ3YWxrIHRvXCIsIFwiZ29cIiwgXCJ3YWxrXCIsIFwiY2RcIl0sIFwiZ29cIiwgR29Db21tYW5kKSxcclxuICAgICAgICAgICAgbmV3IEludGVyYWN0aW9uKFtcImhlbHBcIiwgXCI/XCJdLCBcIlwiLCBIZWxwQ29tbWFuZClcclxuICAgICAgICBdO1xyXG5cclxuICAgICAgICBIZWxwQ29tbWFuZC5pbnRlcmFjdGlvbnMgPSBpbnRlcmFjdGlvbnM7XHJcblxyXG4gICAgICAgIGludGVyYWN0aW9ucy5mb3JDbWQgPSBmdW5jdGlvbiAoY21kKSB7XHJcbiAgICAgICAgICAgIHZhciB1c2VkQ21kID0gXCJcIjtcclxuICAgICAgICAgICAgdmFyIG1hdGNoZXMgPSAkLmdyZXAoaW50ZXJhY3Rpb25zLCBmdW5jdGlvbiAoaW50ZXJhY3Rpb24pIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBpbnRlcmFjdGlvbi5jbWRzLnNvbWUoZnVuY3Rpb24gKGlDbWQpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoY21kLnN1YnN0cigwLCBpQ21kLmxlbmd0aCkgPT09IGlDbWQgJiZcclxuICAgICAgICAgICAgICAgICAgICAgICAgKGNtZC5sZW5ndGggPT0gaUNtZC5sZW5ndGggfHwgY21kW2lDbWQubGVuZ3RoXSA9PSBcIiBcIikpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdXNlZENtZCA9IGlDbWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHZhciBpbnRlcmFjdGlvbiA9IG1hdGNoZXMubGVuZ3RoID4gMCA/IG1hdGNoZXNbMF0gOiBudWxsO1xyXG4gICAgICAgICAgICB2YXIgcGFyYW0gPSBjbWQuc3Vic3RyKHVzZWRDbWQubGVuZ3RoKS50cmltKCk7XHJcbiAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICBkbzogZnVuY3Rpb24gKGdhbWVTdGF0ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpbnRlcmFjdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpbnRlcmFjdGlvbi5kbyhnYW1lU3RhdGUsIHVzZWRDbWQsIHBhcmFtKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgZWxzZTogZnVuY3Rpb24gKGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFpbnRlcmFjdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHJldHVybiBpbnRlcmFjdGlvbnM7XHJcbiAgICB9XSk7XHJcblxyXG5tb2R1bGUuc2VydmljZShcIkVudGl0eVwiLCBbXCJnZXRPckRlZmF1bHRcIiwgZnVuY3Rpb24gKGdldE9yRGVmYXVsdCkge1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChuYW1lLCBtb2RlbCwgcGFyZW50KSB7XHJcbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcclxuICAgICAgICB0aGlzLnBhcmVudCA9IHBhcmVudDtcclxuXHJcbiAgICAgICAgdGhpcy50ZXh0ID0gbW9kZWwudGV4dDtcclxuICAgICAgICB0aGlzLmltYWdlVXJsID0gbW9kZWwuaW1hZ2VVcmw7XHJcblxyXG4gICAgICAgIHRoaXMudmlzaWJsZSA9IGdldE9yRGVmYXVsdChtb2RlbC52aXNpYmxlLCB0cnVlKTtcclxuICAgICAgICB0aGlzLmVuYWJsZWQgPSBnZXRPckRlZmF1bHQobW9kZWwuZW5hYmxlZCwgdHJ1ZSk7XHJcblxyXG4gICAgICAgIHRoaXMuc3RhdGUgPSBtb2RlbC5zdGF0ZSB8fCBcIlwiO1xyXG5cclxuICAgICAgICB0aGlzLnVzZSA9IG1vZGVsLnVzZSB8fCBudWxsO1xyXG4gICAgICAgIHRoaXMudXNlX3dpdGggPSBtb2RlbC51c2Vfd2l0aCB8fCBudWxsO1xyXG4gICAgICAgIHRoaXMudGFrZSA9IG1vZGVsLnRha2UgfHwgbnVsbDtcclxuICAgICAgICB0aGlzLmxvb2sgPSBtb2RlbC5sb29rIHx8IG51bGw7XHJcblxyXG4gICAgICAgIHRoaXMub2JqZWN0cyA9IG1vZGVsLm9iamVjdHMgfHwge307XHJcblxyXG4gICAgICAgIC8vZm9yIGxvY2F0aW9uc1xyXG4gICAgICAgIHRoaXMuYWRqYWNlbnQgPSBtb2RlbC5hZGphY2VudCB8fCBbXTtcclxuXHJcbiAgICAgICAgdGhpcy5yZW1vdmUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnBhcmVudCAmJiB0aGlzLm5hbWUgaW4gdGhpcy5wYXJlbnQub2JqZWN0cykge1xyXG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMucGFyZW50Lm9iamVjdHNbdGhpcy5uYW1lXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHRoaXMuYWRkID0gZnVuY3Rpb24gKGVudGl0eSkge1xyXG4gICAgICAgICAgICB0aGlzLm9iamVjdHNbZW50aXR5Lm5hbWVdID0gZW50aXR5O1xyXG4gICAgICAgICAgICBlbnRpdHkucGFyZW50ID0gdGhpcztcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1dKTtcclxuXHJcbm1vZHVsZS5mYWN0b3J5KFwiYnVpbGRFbnRpdHlNYXBcIiwgW1wiRW50aXR5XCIsIGZ1bmN0aW9uIChFbnRpdHkpIHtcclxuICAgIHJldHVybiBmdW5jdGlvbiAobW9kZWwpIHtcclxuICAgICAgICB2YXIgYWxsRW50aXRpZXMgPSB7fTtcclxuICAgICAgICBmb3IgKHZhciBrZXkgaW4gbW9kZWwubG9jYXRpb25zKSB7XHJcbiAgICAgICAgICAgIHZhciBsb2MgPSBtb2RlbC5sb2NhdGlvbnNba2V5XTtcclxuICAgICAgICAgICAgdmFyIGxvY0VudGl0eSA9IG5ldyBFbnRpdHkoa2V5LCBsb2MsIG51bGwpO1xyXG4gICAgICAgICAgICBhbGxFbnRpdGllc1trZXldID0gbG9jRW50aXR5O1xyXG5cclxuICAgICAgICAgICAgZm9yICh2YXIgb2JqS2V5IGluIGxvYy5vYmplY3RzKSB7XHJcbiAgICAgICAgICAgICAgICBhbGxFbnRpdGllc1tvYmpLZXldID0gbmV3IEVudGl0eShvYmpLZXksIGxvYy5vYmplY3RzW29iaktleV0sIGxvY0VudGl0eSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgT2JqZWN0LmtleXMoYWxsRW50aXRpZXMpLmZvckVhY2goZnVuY3Rpb24gKG5hbWUpIHtcclxuICAgICAgICAgICAgdmFyIGVudGl0eSA9IGFsbEVudGl0aWVzW25hbWVdO1xyXG4gICAgICAgICAgICB2YXIgb2JqZWN0TW9kZWwgPSBlbnRpdHkub2JqZWN0cztcclxuICAgICAgICAgICAgZW50aXR5Lm9iamVjdHMgPSB7fTtcclxuICAgICAgICAgICAgT2JqZWN0LmtleXMob2JqZWN0TW9kZWwpLmZvckVhY2goZnVuY3Rpb24gKG9iak5hbWUpIHtcclxuICAgICAgICAgICAgICAgIGVudGl0eS5vYmplY3RzW29iak5hbWVdID0gYWxsRW50aXRpZXNbb2JqTmFtZV07XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBhbGxFbnRpdGllcztcclxuICAgIH1cclxufV0pO1xyXG5cclxubW9kdWxlLnNlcnZpY2UoXCJHYW1lU3RhdGVcIiwgW1wiYnVpbGRFbnRpdHlNYXBcIiwgXCJFbnRpdHlcIiwgXCJJbnRlcmFjdGlvbnNcIiwgXCJQcmVkaWN0aW9uU2VydmljZVwiLFxyXG4gICAgZnVuY3Rpb24gKGJ1aWxkRW50aXR5TWFwLCBFbnRpdHksIGludGVyYWN0aW9ucywgcHJlZGljdGlvblNlcnZpY2UpIHtcclxuICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGdhbWUsIHByaW50ZXIsIHdpbkNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgIHZhciBnYW1lU3RhdGUgPSB0aGlzO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5nYW1lID0gZ2FtZTtcclxuICAgICAgICAgICAgdGhpcy5wcmludCA9IHByaW50ZXI7XHJcbiAgICAgICAgICAgIHRoaXMucHJlZGljdGlvblNlcnZpY2UgPSBwcmVkaWN0aW9uU2VydmljZTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuYWxsRW50aXRpZXMgPSBidWlsZEVudGl0eU1hcChnYW1lLm1vZGVsKTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMubG9jYXRpb24gPSB0aGlzLmFsbEVudGl0aWVzW2dhbWUuc3RhcnRMb2NhdGlvbk5hbWVdO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5pbnZlbnRvcnkgPSBuZXcgRW50aXR5KFwiaW52ZW50b3J5XCIsIHt9LCBudWxsKTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMucHJpbnQoZ2FtZS5zdGFydFRleHQpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy53aW4gPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnByaW50KFwiWU9VIFdJTiBUSEUgR0FNRVwiKTtcclxuICAgICAgICAgICAgICAgIHdpbkNhbGxiYWNrKCk7XHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAvL2NyZWF0ZSBmbGF0dGVuZWQgbGlzdCBvZiBhbGwgcG9zc2libGUgY29tbWFuZHMsIGZvciB0aGUgcHJlZGljdGlvbiBzZXJ2aWNlXHJcbiAgICAgICAgICAgIHRoaXMuY29tbWFuZExpc3QgPSBbXTtcclxuICAgICAgICAgICAgaW50ZXJhY3Rpb25zLmZvckVhY2goZnVuY3Rpb24gKGludGVyYWN0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICBnYW1lU3RhdGUuY29tbWFuZExpc3QucHVzaC5hcHBseShnYW1lU3RhdGUuY29tbWFuZExpc3QsIGludGVyYWN0aW9uLmNtZHMpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdGhpcy5lbnRlciA9IGZ1bmN0aW9uICh0ZXh0KSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgdHJpbW1lZFRleHQgPSB0ZXh0LnRyaW0oKTtcclxuICAgICAgICAgICAgICAgIGludGVyYWN0aW9ucy5mb3JDbWQodHJpbW1lZFRleHQpXHJcbiAgICAgICAgICAgICAgICAgICAgLmRvKHRoaXMpXHJcbiAgICAgICAgICAgICAgICAgICAgLmVsc2UoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJlZGljdGlvbiA9IHByZWRpY3Rpb25TZXJ2aWNlLmZpbmRDbG9zZXN0RWxlbWVudCh0cmltbWVkVGV4dCwgZ2FtZVN0YXRlLmNvbW1hbmRMaXN0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByZWRpY3Rpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhbWVTdGF0ZS5wcmludChcIkRpZCB5b3UgbWVhbiBcIiArIHByZWRpY3Rpb24gKyBcIj9cIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYW1lU3RhdGUucHJpbnQoXCJJIGRvbid0IHVuZGVyc3RhbmQgJ1wiICsgdHJpbW1lZFRleHQgKyBcIicuXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XSk7XHJcblxyXG5tb2R1bGUuc2VydmljZShcIkdhbWVcIiwgW1wiR2FtZVN0YXRlXCIsIGZ1bmN0aW9uIChHYW1lU3RhdGUpIHtcclxuICAgIHJldHVybiBmdW5jdGlvbiAobW9kZWwpIHtcclxuICAgICAgICB0aGlzLnN0YXJ0TG9jYXRpb25OYW1lID0gbW9kZWwuc3RhcnQ7XHJcbiAgICAgICAgdGhpcy5zdGFydFRleHQgPSBtb2RlbC5zdGFydF90ZXh0O1xyXG4gICAgICAgIHRoaXMubW9kZWwgPSBtb2RlbDtcclxuXHJcbiAgICAgICAgdGhpcy5zdGFydCA9IGZ1bmN0aW9uIChwcmludGVyLCB3aW5DYWxsYmFjaykge1xyXG4gICAgICAgICAgICByZXR1cm4gbmV3IEdhbWVTdGF0ZSh0aGlzLCBwcmludGVyLCB3aW5DYWxsYmFjayk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XSk7XHJcbiIsIlwidXNlIHN0cmljdFwiO1xyXG5cclxudmFyIHByZWRpY3Rpb24gPSBhbmd1bGFyLm1vZHVsZShcImpzdGV4dC5wcmVkaWN0aW9uXCIsIFtdKTtcclxucHJlZGljdGlvbi5jb25zdGFudChcIkhBTU1JTkdfVEhSRVNIT0xEXCIsIDQpO1xyXG5cclxucHJlZGljdGlvbi5mYWN0b3J5KFwiUHJlZGljdGlvblNlcnZpY2VcIiwgW1wiSEFNTUlOR19USFJFU0hPTERcIiwgZnVuY3Rpb24oSEFNTUlOR19USFJFU0hPTEQpIHtcclxuICAgIHZhciBzZXJ2aWNlID0ge307XHJcbiAgICBzZXJ2aWNlLmZpbmRDbG9zZXN0RWxlbWVudCA9IGZ1bmN0aW9uIGZpbmRDbG9zZXN0RWxlbWVudCAoZWxlbWVudCwgaGF5c3RhY2spIHtcclxuICAgICAgICB0aGlzLmZpbmRIYW1taW5nRGlzdGFuY2UgPSBmdW5jdGlvbiBmaW5kSGFtbWluZ0Rpc3RhbmNlKGEsIGIpIHtcclxuICAgICAgICAgICAgdmFyIGZpcnN0SXNTaG9ydGVyID0gYS5sZW5ndGggPD0gYi5sZW5ndGg7XHJcbiAgICAgICAgICAgIHZhciBzaG9ydGVyID0gKGZpcnN0SXNTaG9ydGVyID8gYSA6IGIpLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgICAgIHZhciBsb25nZXIgPSAoIWZpcnN0SXNTaG9ydGVyID8gYSA6IGIpLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgICAgIHZhciBoYW1taW5nRGlzdGFuY2UgPSAwO1xyXG5cclxuICAgICAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IGxvbmdlci5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgLy8gUGFkIFN0cmluZyBzbyBib3RoIGhhdmUgdGhlIHNhbWUgbGVuZ3RoLCB1c2UgMCBzbyB0aGUgaGFtbWluZyBkaXN0YW5jZSBpbmNyZWFzZXMgZm9yIGVhY2ggYWRkaXRpb25hbCBjaGFyYWN0ZXJcclxuICAgICAgICAgICAgICAgIGlmKHNob3J0ZXIubGVuZ3RoID09PSBpKSB7IHNob3J0ZXIgPSBzaG9ydGVyICsgJyAnOyB9XHJcbiAgICAgICAgICAgICAgICBpZiAoc2hvcnRlci5jaGFyQXQoaSkgIT09IGxvbmdlci5jaGFyQXQoaSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBoYW1taW5nRGlzdGFuY2UgKz0gMTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIGhhbW1pbmdEaXN0YW5jZTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICB2YXIgbWluRGlzdGFuY2UgPSBOdW1iZXIuTUFYX1ZBTFVFO1xyXG4gICAgICAgIHZhciBjbG9zZXN0RWxlbWVudCA9IG51bGw7XHJcbiAgICAgICAgdmFyIGZvdW5kRWxlO1xyXG4gICAgICAgIGZvciAodmFyIGkgaW4gaGF5c3RhY2spIHtcclxuICAgICAgICAgICAgdmFyIHRlc3QgPSBoYXlzdGFja1tpXTtcclxuICAgICAgICAgICAgaWYodGVzdC5sZW5ndGggPCAyKSB7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgY3VycmVudEVsZSA9IGVsZW1lbnQ7XHJcbiAgICAgICAgICAgIGlmKGN1cnJlbnRFbGUubGVuZ3RoID4gdGVzdC5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIGN1cnJlbnRFbGUgPSBjdXJyZW50RWxlLnN1YnN0cigwLCB0ZXN0Lmxlbmd0aCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIGN1cnJlbnREaXN0YW5jZSA9IHRoaXMuZmluZEhhbW1pbmdEaXN0YW5jZShjdXJyZW50RWxlLCB0ZXN0KTtcclxuICAgICAgICAgICAgaWYgKGN1cnJlbnREaXN0YW5jZSA8IG1pbkRpc3RhbmNlKSB7XHJcbiAgICAgICAgICAgICAgICBtaW5EaXN0YW5jZSA9IGN1cnJlbnREaXN0YW5jZTtcclxuICAgICAgICAgICAgICAgIGNsb3Nlc3RFbGVtZW50ID0gdGVzdDtcclxuICAgICAgICAgICAgICAgIGZvdW5kRWxlID0gY3VycmVudEVsZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gSWYgdGhlIGRpc3RhbmNlIGlzIGdyZWF0ZXIgdGhhbiB0aGUgdGhyZXNob2xkLCB0aGUgY2xvc2VzdCBlbGVtZW50IGlzIHRvbyBkaWZmZXJlbnRcclxuICAgICAgICAvLyBsaW1pdCB0aHJlc2hvbGQgdG8gbGVuZ3RoIG9mIGlucHV0IC0gMSwgdG8gYXZvaWQgZmluZGluZyBjb21wbGV0ZWx5IGRpZmZlcmVudCBzdHJpbmdzXHJcbiAgICAgICAgdmFyIHRocmVzaG9sZCA9IE1hdGgubWluKEhBTU1JTkdfVEhSRVNIT0xELCBmb3VuZEVsZS5sZW5ndGggLSAxKTtcclxuICAgICAgICByZXR1cm4gbWluRGlzdGFuY2UgPD0gdGhyZXNob2xkID8gY2xvc2VzdEVsZW1lbnQgOiBudWxsO1xyXG4gICAgfTtcclxuXHJcbiAgICByZXR1cm4gc2VydmljZTtcclxufV0pOyJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==