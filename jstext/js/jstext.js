function formatText(text){return text.replace(/%n/g,"<br/>")}var module=angular.module("jstext.game",["jstext.prediction"]);module.constant("WITH_SEPARATOR"," with "),module.constant("getOrDefault",function(value,defaultValue){return"undefined"!=typeof value?value:defaultValue}),module.factory("Actions",["getOrDefault",function(getOrDefault){return{enable:function(gameState,action,entity){entity.enabled=getOrDefault(action.value,!entity.enabled)},remove:function(gameState,action,entity){entity.remove()},state:function(gameState,action,entity){entity.state=action.value},take:function(gameState,action,entity){entity.remove(),gameState.inventory.add(entity)},visible:function(gameState,action,entity){entity.visible=getOrDefault(action.value,!entity.visible)},win:function(gameState,action,entity){gameState.win()}}}]),module.constant("Conditions",{state:function(gameState,condition,entity){return entity.state===condition.value},item:function(gameState,condition,entity){return entity.name in gameState.inventory.objects}}),module.factory("EntityCommand",["Actions","Conditions","WITH_SEPARATOR",function(actions,conditions,WITH_SEPARATOR){return function(gameState,cmd,cmdKey,param){var entityName,withItemName,withIndex=param.indexOf(WITH_SEPARATOR);withIndex>=0?(entityName=param.substr(withIndex+WITH_SEPARATOR.length),withItemName=param.substr(0,withIndex)):(entityName=param,withItemName=null);var current=gameState.location,entity=0==entityName.length?current:current.objects[entityName];if(!withItemName||withItemName in gameState.inventory.objects)if(entity&&entity.visible)if(entity.enabled){var action=entity[withItemName?cmdKey+"_with":cmdKey];if(action)if(withItemName&&withItemName!==action.item)gameState.print("Can not use "+withItemName+" with this.");else{var conditionMet=!0;action["if"]&&action["if"].forEach(function(condition){var conditionFunc=conditions[condition.type];if(conditionFunc){var targets=condition.targets||[entity.name];conditionMet=targets.every(function(targetId){var entity=gameState.allEntities[targetId],result=conditionFunc(gameState,condition,entity);return result||gameState.print(condition["else"]),result})}}),conditionMet&&(action.text&&gameState.print(action.text),action["do"]&&action["do"].forEach(function(doAction){var actionFunc=actions[doAction.type];if(actionFunc){var targets=doAction.targets||[entity.name];targets.forEach(function(targetId){var entity=gameState.allEntities[targetId];actionFunc(gameState,doAction,entity)})}}))}else gameState.print("Not possible.")}else gameState.print("Not possible right now.");else gameState.print("Can not "+cmd+": "+entityName+" not found");else gameState.print(withItemName+" not in inventory.")}}]),module.factory("GoCommand",[function(){return function(gameState,cmd,cmdKey,param){var locationName=param;if(locationName){var location=gameState.allEntities[locationName];location&&location.visible?location===gameState.location?gameState.print("You are already at "+locationName):!location.enabled||gameState.location.adjacent.indexOf(location.name)<0?gameState.print("Can not go to "+location.name):(gameState.location=location,gameState.print("You are now at: "+location.name)):gameState.print(locationName+" not found. Can not go.")}else gameState.print("Where to go to?")}}]),module.factory("HelpCommand",[function(){function helpCmd(gameState,cmd,cmdKey,param){gameState.print("Available commands: "+helpCmd.interactions.map(function(interaction){return interaction.cmds[0]}).join(", ")+".")}return helpCmd.interactions=[],helpCmd}]),module.service("Interaction",[function(){return function(cmds,cmdKey,command){this.cmds=cmds,this["do"]=function(gameState,cmd,param){command(gameState,cmd,cmdKey,param)}}}]),module.factory("Interactions",["Interaction","EntityCommand","GoCommand","HelpCommand",function(Interaction,EntityCommand,GoCommand,HelpCommand){var interactions=[new Interaction(["use"],"use",EntityCommand),new Interaction(["take","pick up"],"take",EntityCommand),new Interaction(["look at","look","inspect"],"look",EntityCommand),new Interaction(["go to","walk to","go","walk","cd"],"go",GoCommand),new Interaction(["help","?"],"",HelpCommand)];return HelpCommand.interactions=interactions,interactions.forCmd=function(cmd){var usedCmd="",matches=$.grep(interactions,function(interaction){return interaction.cmds.some(function(iCmd){return cmd.substr(0,iCmd.length)!==iCmd||cmd.length!=iCmd.length&&" "!=cmd[iCmd.length]?!1:(usedCmd=iCmd,!0)})}),interaction=matches.length>0?matches[0]:null,param=cmd.substr(usedCmd.length).trim();return{"do":function(gameState){return interaction&&interaction["do"](gameState,usedCmd,param),this},"else":function(callback){interaction||callback()}}},interactions}]),module.service("Entity",["getOrDefault",function(getOrDefault){return function(name,model,parent){this.name=name,this.parent=parent,this.text=model.text,this.imageUrl=model.imageUrl,this.visible=getOrDefault(model.visible,!0),this.enabled=getOrDefault(model.enabled,!0),this.state=model.state||"",this.use=model.use||null,this.use_with=model.use_with||null,this.take=model.take||null,this.look=model.look||null,this.objects=model.objects||{},this.adjacent=model.adjacent||[],this.remove=function(){this.parent&&this.name in this.parent.objects&&delete this.parent.objects[this.name]},this.add=function(entity){this.objects[entity.name]=entity,entity.parent=this}}}]),module.factory("buildEntityMap",["Entity",function(Entity){return function(model){var allEntities={};for(var key in model.locations){var loc=model.locations[key],locEntity=new Entity(key,loc,null);allEntities[key]=locEntity;for(var objKey in loc.objects)allEntities[objKey]=new Entity(objKey,loc.objects[objKey],locEntity)}return Object.keys(allEntities).forEach(function(name){var entity=allEntities[name],objectModel=entity.objects;entity.objects={},Object.keys(objectModel).forEach(function(objName){entity.objects[objName]=allEntities[objName]})}),allEntities}}]),module.service("GameState",["buildEntityMap","Entity","Interactions","PredictionService",function(buildEntityMap,Entity,interactions,predictionService){return function(game,printer,winCallback){var gameState=this;this.game=game,this.print=printer,this.predictionService=predictionService,this.allEntities=buildEntityMap(game.model),this.location=this.allEntities[game.startLocationName],this.inventory=new Entity("inventory",{},null),this.print(game.startText),this.win=function(){this.print("YOU WIN THE GAME"),winCallback()},this.commandList=[],interactions.forEach(function(interaction){gameState.commandList.push.apply(gameState.commandList,interaction.cmds)}),this.enter=function(text){var trimmedText=text.trim();interactions.forCmd(trimmedText)["do"](this)["else"](function(){var prediction=predictionService.findClosestElement(trimmedText,gameState.commandList);gameState.print(prediction?"Did you mean "+prediction+"?":"I don't understand '"+trimmedText+"'.")})}}}]),module.service("Game",["GameState",function(GameState){return function(model){this.startLocationName=model.start,this.startText=model.start_text,this.model=model,this.start=function(printer,winCallback){return new GameState(this,printer,winCallback)}}}]);var jstext=angular.module("jstext",["ngSanitize","luegg.directives","jstext.prediction","jstext.game"]);jstext.controller("GameController",["$scope","$http","Game",function($scope,$http,Game){$scope.restart=function(){$scope.log=[],$scope.gameState=$scope.game.start($scope.print,$scope.onWin),$scope.inventory=$scope.gameState.inventory.objects},$scope.onWin=function(){},$http.get("game/test.json").then(function(result){$scope.game=new Game(result.data),$scope.restart(),$scope.updateLocation()}),$scope.updateLocation=function(){$scope.location=$scope.gameState?{text:formatText($scope.gameState.location.text),image:$scope.gameState.location.imageUrl||"http://www.theodora.com/maps/new9/time_zones_4.jpg"}:{}},$scope.updateLocation();var addLog=function(text,type){$scope.log.push({index:$scope.log.length,text:text,type:type})};$scope.print=function(text){addLog(formatText(text),"output")},$scope.input="",$scope.command=function(){addLog($scope.input,"input"),"restart"===$scope.input?$scope.restart():($scope.gameState.enter($scope.input),$scope.updateLocation()),$scope.input=""},$scope.useItem=function(name){$scope.input="use "+name+" with ",setTimeout(function(){$("#inputfield").focus()},1)}}]);var prediction=angular.module("jstext.prediction",[]);prediction.constant("HAMMING_THRESHOLD",4),prediction.factory("PredictionService",["HAMMING_THRESHOLD",function(HAMMING_THRESHOLD){var service={};return service.findClosestElement=function(element,haystack){this.findHammingDistance=function(a,b){for(var firstIsShorter=a.length<=b.length,shorter=(firstIsShorter?a:b).toLowerCase(),longer=(firstIsShorter?b:a).toLowerCase(),hammingDistance=0,i=0;i<longer.length;i++)shorter.length===i&&(shorter+=" "),shorter.charAt(i)!==longer.charAt(i)&&(hammingDistance+=1);return hammingDistance};var foundEle,minDistance=Number.MAX_VALUE,closestElement=null;for(var i in haystack){var test=haystack[i];if(!(test.length<2)){var currentEle=element;currentEle.length>test.length&&(currentEle=currentEle.substr(0,test.length));var currentDistance=this.findHammingDistance(currentEle,test);minDistance>currentDistance&&(minDistance=currentDistance,closestElement=test,foundEle=currentEle)}}var threshold=Math.min(HAMMING_THRESHOLD,foundEle.length-1);return threshold>=minDistance?closestElement:null},service}]);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpzdGV4dC5qcyIsImdhbWUuanMiLCJwcmVkaWN0aW9uU2VydmljZS5qcyJdLCJuYW1lcyI6WyJmb3JtYXRUZXh0IiwidGV4dCIsInJlcGxhY2UiLCJtb2R1bGUiLCJhbmd1bGFyIiwiY29uc3RhbnQiLCJ2YWx1ZSIsImRlZmF1bHRWYWx1ZSIsImZhY3RvcnkiLCJnZXRPckRlZmF1bHQiLCJlbmFibGUiLCJnYW1lU3RhdGUiLCJhY3Rpb24iLCJlbnRpdHkiLCJlbmFibGVkIiwicmVtb3ZlIiwic3RhdGUiLCJ0YWtlIiwiaW52ZW50b3J5IiwiYWRkIiwidmlzaWJsZSIsIndpbiIsImNvbmRpdGlvbiIsIml0ZW0iLCJuYW1lIiwib2JqZWN0cyIsImFjdGlvbnMiLCJjb25kaXRpb25zIiwiV0lUSF9TRVBBUkFUT1IiLCJjbWQiLCJjbWRLZXkiLCJwYXJhbSIsImVudGl0eU5hbWUiLCJ3aXRoSXRlbU5hbWUiLCJ3aXRoSW5kZXgiLCJpbmRleE9mIiwic3Vic3RyIiwibGVuZ3RoIiwiY3VycmVudCIsImxvY2F0aW9uIiwicHJpbnQiLCJjb25kaXRpb25NZXQiLCJmb3JFYWNoIiwiY29uZGl0aW9uRnVuYyIsInR5cGUiLCJ0YXJnZXRzIiwiZXZlcnkiLCJ0YXJnZXRJZCIsImFsbEVudGl0aWVzIiwicmVzdWx0IiwiZG9BY3Rpb24iLCJhY3Rpb25GdW5jIiwibG9jYXRpb25OYW1lIiwiYWRqYWNlbnQiLCJoZWxwQ21kIiwiaW50ZXJhY3Rpb25zIiwibWFwIiwiaW50ZXJhY3Rpb24iLCJjbWRzIiwiam9pbiIsInNlcnZpY2UiLCJjb21tYW5kIiwidGhpcyIsIkludGVyYWN0aW9uIiwiRW50aXR5Q29tbWFuZCIsIkdvQ29tbWFuZCIsIkhlbHBDb21tYW5kIiwiZm9yQ21kIiwidXNlZENtZCIsIm1hdGNoZXMiLCIkIiwiZ3JlcCIsInNvbWUiLCJpQ21kIiwidHJpbSIsImRvIiwiZWxzZSIsImNhbGxiYWNrIiwibW9kZWwiLCJwYXJlbnQiLCJpbWFnZVVybCIsInVzZSIsInVzZV93aXRoIiwibG9vayIsIkVudGl0eSIsImtleSIsImxvY2F0aW9ucyIsImxvYyIsImxvY0VudGl0eSIsIm9iaktleSIsIk9iamVjdCIsImtleXMiLCJvYmplY3RNb2RlbCIsIm9iak5hbWUiLCJidWlsZEVudGl0eU1hcCIsInByZWRpY3Rpb25TZXJ2aWNlIiwiZ2FtZSIsInByaW50ZXIiLCJ3aW5DYWxsYmFjayIsInN0YXJ0TG9jYXRpb25OYW1lIiwic3RhcnRUZXh0IiwiY29tbWFuZExpc3QiLCJwdXNoIiwiYXBwbHkiLCJlbnRlciIsInRyaW1tZWRUZXh0IiwicHJlZGljdGlvbiIsImZpbmRDbG9zZXN0RWxlbWVudCIsIkdhbWVTdGF0ZSIsInN0YXJ0Iiwic3RhcnRfdGV4dCIsImpzdGV4dCIsImNvbnRyb2xsZXIiLCIkc2NvcGUiLCIkaHR0cCIsIkdhbWUiLCJyZXN0YXJ0IiwibG9nIiwib25XaW4iLCJnZXQiLCJ0aGVuIiwiZGF0YSIsInVwZGF0ZUxvY2F0aW9uIiwiaW1hZ2UiLCJhZGRMb2ciLCJpbmRleCIsImlucHV0IiwidXNlSXRlbSIsInNldFRpbWVvdXQiLCJmb2N1cyIsIkhBTU1JTkdfVEhSRVNIT0xEIiwiZWxlbWVudCIsImhheXN0YWNrIiwiZmluZEhhbW1pbmdEaXN0YW5jZSIsImEiLCJiIiwiZmlyc3RJc1Nob3J0ZXIiLCJzaG9ydGVyIiwidG9Mb3dlckNhc2UiLCJsb25nZXIiLCJoYW1taW5nRGlzdGFuY2UiLCJpIiwiY2hhckF0IiwiZm91bmRFbGUiLCJtaW5EaXN0YW5jZSIsIk51bWJlciIsIk1BWF9WQUxVRSIsImNsb3Nlc3RFbGVtZW50IiwidGVzdCIsImN1cnJlbnRFbGUiLCJjdXJyZW50RGlzdGFuY2UiLCJ0aHJlc2hvbGQiLCJNYXRoIiwibWluIl0sIm1hcHBpbmdzIjoiQUFHQSxRQUFBQSxZQUFBQyxNQUNBLE1BQUFBLE1BQUFDLFFBQUEsTUFBQSxTQ0FBLEdBQUFDLFFBQUFDLFFBQUFELE9BQUEsZUFBQSxxQkFFQUEsUUFBQUUsU0FBQSxpQkFBQSxVQUVBRixP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SixTQUFBLEtBQ0FBLFFBQUFLLE9BQUFELEtBQUFGLE9BQUFHLE9BQUFELEtBQ0FELGlCQUFBLEVBSUEsT0FBQUEsaUJBR0EsSUFFQUcsVUFGQUMsWUFBQUMsT0FBQUMsVUFDQUMsZUFBQSxJQUVBLEtBQUEsR0FBQU4sS0FBQVQsVUFBQSxDQUNBLEdBQUFnQixNQUFBaEIsU0FBQVMsRUFDQSxNQUFBTyxLQUFBL0csT0FBQSxHQUFBLENBR0EsR0FBQWdILFlBQUFsQixPQUNBa0IsWUFBQWhILE9BQUErRyxLQUFBL0csU0FDQWdILFdBQUFBLFdBQUFqSCxPQUFBLEVBQUFnSCxLQUFBL0csUUFFQSxJQUFBaUgsaUJBQUF4RixLQUFBdUUsb0JBQUFnQixXQUFBRCxLQUNBSixhQUFBTSxrQkFDQU4sWUFBQU0sZ0JBQ0FILGVBQUFDLEtBQ0FMLFNBQUFNLGFBTUEsR0FBQUUsV0FBQUMsS0FBQUMsSUFBQXZCLGtCQUFBYSxTQUFBMUcsT0FBQSxFQUNBLE9BQUFrSCxZQUFBUCxZQUFBRyxlQUFBLE1BR0F2RiIsImZpbGUiOiJqc3RleHQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcclxuXHJcbnZhciBqc3RleHQgPSBhbmd1bGFyLm1vZHVsZShcImpzdGV4dFwiLCBbXCJuZ1Nhbml0aXplXCIsIFwibHVlZ2cuZGlyZWN0aXZlc1wiLCBcImpzdGV4dC5wcmVkaWN0aW9uXCIsIFwianN0ZXh0LmdhbWVcIl0pO1xyXG5mdW5jdGlvbiBmb3JtYXRUZXh0KHRleHQpIHtcclxuICAgIHJldHVybiB0ZXh0LnJlcGxhY2UoLyVuL2csIFwiPGJyLz5cIik7XHJcbn1cclxuXHJcbmpzdGV4dC5jb250cm9sbGVyKFwiR2FtZUNvbnRyb2xsZXJcIiwgW1wiJHNjb3BlXCIsIFwiJGh0dHBcIiwgXCJHYW1lXCIsIGZ1bmN0aW9uICgkc2NvcGUsICRodHRwLCBHYW1lKSB7XHJcblxyXG4gICAgJHNjb3BlLnJlc3RhcnQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgJHNjb3BlLmxvZyA9IFtdO1xyXG4gICAgICAgICRzY29wZS5nYW1lU3RhdGUgPSAkc2NvcGUuZ2FtZS5zdGFydCgkc2NvcGUucHJpbnQsICRzY29wZS5vbldpbik7XHJcbiAgICAgICAgJHNjb3BlLmludmVudG9yeSA9ICRzY29wZS5nYW1lU3RhdGUuaW52ZW50b3J5Lm9iamVjdHM7XHJcbiAgICB9O1xyXG5cclxuICAgICRzY29wZS5vbldpbiA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgIC8vICRzY29wZS5yZXN0YXJ0KCk7XHJcbiAgICB9O1xyXG5cclxuICAgICRodHRwLmdldChcImdhbWUvdGVzdC5qc29uXCIpLnRoZW4oZnVuY3Rpb24gKHJlc3VsdCkge1xyXG4gICAgICAgICRzY29wZS5nYW1lID0gbmV3IEdhbWUocmVzdWx0LmRhdGEpO1xyXG4gICAgICAgICRzY29wZS5yZXN0YXJ0KCk7XHJcbiAgICAgICAgJHNjb3BlLnVwZGF0ZUxvY2F0aW9uKCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICAkc2NvcGUudXBkYXRlTG9jYXRpb24gPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgJHNjb3BlLmxvY2F0aW9uID0gJHNjb3BlLmdhbWVTdGF0ZSA/IHtcclxuICAgICAgICAgICAgdGV4dDogZm9ybWF0VGV4dCgkc2NvcGUuZ2FtZVN0YXRlLmxvY2F0aW9uLnRleHQpLFxyXG4gICAgICAgICAgICBpbWFnZTogJHNjb3BlLmdhbWVTdGF0ZS5sb2NhdGlvbi5pbWFnZVVybCB8fCBcImh0dHA6Ly93d3cudGhlb2RvcmEuY29tL21hcHMvbmV3OS90aW1lX3pvbmVzXzQuanBnXCJcclxuICAgICAgICB9IDoge307XHJcbiAgICB9O1xyXG4gICAgJHNjb3BlLnVwZGF0ZUxvY2F0aW9uKCk7XHJcblxyXG4gICAgdmFyIGFkZExvZyA9IGZ1bmN0aW9uKHRleHQsIHR5cGUpIHtcclxuICAgICAgICAkc2NvcGUubG9nLnB1c2goe1xyXG4gICAgICAgICAgICBpbmRleDogJHNjb3BlLmxvZy5sZW5ndGgsXHJcbiAgICAgICAgICAgIHRleHQ6IHRleHQsXHJcbiAgICAgICAgICAgIHR5cGU6IHR5cGVcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgJHNjb3BlLnByaW50ID0gZnVuY3Rpb24gKHRleHQpIHtcclxuICAgICAgICBhZGRMb2coZm9ybWF0VGV4dCh0ZXh0KSwgXCJvdXRwdXRcIik7XHJcbiAgICB9O1xyXG5cclxuICAgICRzY29wZS5pbnB1dCA9IFwiXCI7XHJcbiAgICAkc2NvcGUuY29tbWFuZCA9IGZ1bmN0aW9uIGNvbW1hbmQoKSB7XHJcbiAgICAgICAgYWRkTG9nKCRzY29wZS5pbnB1dCwgXCJpbnB1dFwiKTtcclxuICAgICAgICBpZiAoJHNjb3BlLmlucHV0ID09PSBcInJlc3RhcnRcIikge1xyXG4gICAgICAgICAgICAkc2NvcGUucmVzdGFydCgpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICRzY29wZS5nYW1lU3RhdGUuZW50ZXIoJHNjb3BlLmlucHV0KTtcclxuICAgICAgICAgICAgJHNjb3BlLnVwZGF0ZUxvY2F0aW9uKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgICRzY29wZS5pbnB1dCA9IFwiXCI7XHJcbiAgICB9O1xyXG5cclxuICAgICRzY29wZS51c2VJdGVtID0gZnVuY3Rpb24obmFtZSkge1xyXG4gICAgICAgICRzY29wZS5pbnB1dCA9IFwidXNlIFwiICsgbmFtZSArIFwiIHdpdGggXCI7XHJcbiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsgJChcIiNpbnB1dGZpZWxkXCIpLmZvY3VzKCkgfSwgMSk7XHJcbiAgICB9XHJcbn1dKTsiLCIvKipcclxuICogQ3JlYXRlZCBieSBDaHJpc3Ugb24gMjYuMDUuMjAxNS5cclxuICovXHJcblxyXG52YXIgbW9kdWxlID0gYW5ndWxhci5tb2R1bGUoXCJqc3RleHQuZ2FtZVwiLCBbXCJqc3RleHQucHJlZGljdGlvblwiXSk7XHJcblxyXG5tb2R1bGUuY29uc3RhbnQoXCJXSVRIX1NFUEFSQVRPUlwiLCBcIiB3aXRoIFwiKTtcclxuXHJcbm1vZHVsZS5jb25zdGFudChcImdldE9yRGVmYXVsdFwiLCBmdW5jdGlvbiAodmFsdWUsIGRlZmF1bHRWYWx1ZSkge1xyXG4gICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSAhPT0gXCJ1bmRlZmluZWRcIiA/IHZhbHVlIDogZGVmYXVsdFZhbHVlO1xyXG59KTtcclxuXHJcbm1vZHVsZS5mYWN0b3J5KFwiQWN0aW9uc1wiLCBbXCJnZXRPckRlZmF1bHRcIiwgZnVuY3Rpb24gKGdldE9yRGVmYXVsdCkge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBlbmFibGU6IGZ1bmN0aW9uIChnYW1lU3RhdGUsIGFjdGlvbiwgZW50aXR5KSB7XHJcbiAgICAgICAgICAgIGVudGl0eS5lbmFibGVkID0gZ2V0T3JEZWZhdWx0KGFjdGlvbi52YWx1ZSwgIWVudGl0eS5lbmFibGVkKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHJlbW92ZTogZnVuY3Rpb24gKGdhbWVTdGF0ZSwgYWN0aW9uLCBlbnRpdHkpIHtcclxuICAgICAgICAgICAgZW50aXR5LnJlbW92ZSgpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc3RhdGU6IGZ1bmN0aW9uIChnYW1lU3RhdGUsIGFjdGlvbiwgZW50aXR5KSB7XHJcbiAgICAgICAgICAgIGVudGl0eS5zdGF0ZSA9IGFjdGlvbi52YWx1ZTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHRha2U6IGZ1bmN0aW9uIChnYW1lU3RhdGUsIGFjdGlvbiwgZW50aXR5KSB7XHJcbiAgICAgICAgICAgIGVudGl0eS5yZW1vdmUoKTtcclxuICAgICAgICAgICAgZ2FtZVN0YXRlLmludmVudG9yeS5hZGQoZW50aXR5KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHZpc2libGU6IGZ1bmN0aW9uIChnYW1lU3RhdGUsIGFjdGlvbiwgZW50aXR5KSB7XHJcbiAgICAgICAgICAgIGVudGl0eS52aXNpYmxlID0gZ2V0T3JEZWZhdWx0KGFjdGlvbi52YWx1ZSwgIWVudGl0eS52aXNpYmxlKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHdpbjogZnVuY3Rpb24gKGdhbWVTdGF0ZSwgYWN0aW9uLCBlbnRpdHkpIHtcclxuICAgICAgICAgICAgZ2FtZVN0YXRlLndpbigpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufV0pO1xyXG5cclxubW9kdWxlLmNvbnN0YW50KFwiQ29uZGl0aW9uc1wiLCB7XHJcbiAgICBzdGF0ZTogZnVuY3Rpb24gKGdhbWVTdGF0ZSwgY29uZGl0aW9uLCBlbnRpdHkpIHtcclxuICAgICAgICByZXR1cm4gZW50aXR5LnN0YXRlID09PSBjb25kaXRpb24udmFsdWU7XHJcbiAgICB9LFxyXG4gICAgaXRlbTogZnVuY3Rpb24gKGdhbWVTdGF0ZSwgY29uZGl0aW9uLCBlbnRpdHkpIHtcclxuICAgICAgICByZXR1cm4gZW50aXR5Lm5hbWUgaW4gZ2FtZVN0YXRlLmludmVudG9yeS5vYmplY3RzO1xyXG4gICAgfVxyXG59KTtcclxuXHJcbm1vZHVsZS5mYWN0b3J5KFwiRW50aXR5Q29tbWFuZFwiLCBbXCJBY3Rpb25zXCIsIFwiQ29uZGl0aW9uc1wiLCBcIldJVEhfU0VQQVJBVE9SXCIsXHJcbiAgICBmdW5jdGlvbiAoYWN0aW9ucywgY29uZGl0aW9ucywgV0lUSF9TRVBBUkFUT1IpIHtcclxuICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGdhbWVTdGF0ZSwgY21kLCBjbWRLZXksIHBhcmFtKSB7XHJcbiAgICAgICAgICAgIHZhciB3aXRoSW5kZXggPSBwYXJhbS5pbmRleE9mKFdJVEhfU0VQQVJBVE9SKTtcclxuICAgICAgICAgICAgdmFyIGVudGl0eU5hbWUsIHdpdGhJdGVtTmFtZTtcclxuICAgICAgICAgICAgaWYgKHdpdGhJbmRleCA+PSAwKSB7XHJcbiAgICAgICAgICAgICAgICBlbnRpdHlOYW1lID0gcGFyYW0uc3Vic3RyKHdpdGhJbmRleCArIFdJVEhfU0VQQVJBVE9SLmxlbmd0aCk7XHJcbiAgICAgICAgICAgICAgICB3aXRoSXRlbU5hbWUgPSBwYXJhbS5zdWJzdHIoMCwgd2l0aEluZGV4KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGVudGl0eU5hbWUgPSBwYXJhbTtcclxuICAgICAgICAgICAgICAgIHdpdGhJdGVtTmFtZSA9IG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHZhciBjdXJyZW50ID0gZ2FtZVN0YXRlLmxvY2F0aW9uO1xyXG4gICAgICAgICAgICB2YXIgZW50aXR5ID0gZW50aXR5TmFtZS5sZW5ndGggPT0gMFxyXG4gICAgICAgICAgICAgICAgPyBjdXJyZW50IDogY3VycmVudC5vYmplY3RzW2VudGl0eU5hbWVdO1xyXG5cclxuICAgICAgICAgICAgaWYgKHdpdGhJdGVtTmFtZSAmJiAhKHdpdGhJdGVtTmFtZSBpbiBnYW1lU3RhdGUuaW52ZW50b3J5Lm9iamVjdHMpKSB7XHJcbiAgICAgICAgICAgICAgICBnYW1lU3RhdGUucHJpbnQod2l0aEl0ZW1OYW1lICsgXCIgbm90IGluIGludmVudG9yeS5cIik7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWVudGl0eSB8fCAhZW50aXR5LnZpc2libGUpIHtcclxuICAgICAgICAgICAgICAgIGdhbWVTdGF0ZS5wcmludChcIkNhbiBub3QgXCIgKyBjbWQgKyBcIjogXCIgKyBlbnRpdHlOYW1lICsgXCIgbm90IGZvdW5kXCIpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKCFlbnRpdHkuZW5hYmxlZCkge1xyXG4gICAgICAgICAgICAgICAgZ2FtZVN0YXRlLnByaW50KFwiTm90IHBvc3NpYmxlIHJpZ2h0IG5vdy5cIilcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHZhciBhY3Rpb24gPSBlbnRpdHlbd2l0aEl0ZW1OYW1lID8gY21kS2V5ICsgXCJfd2l0aFwiIDogY21kS2V5XTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoIWFjdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgIGdhbWVTdGF0ZS5wcmludChcIk5vdCBwb3NzaWJsZS5cIik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHdpdGhJdGVtTmFtZSAmJiB3aXRoSXRlbU5hbWUgIT09IGFjdGlvbi5pdGVtKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZ2FtZVN0YXRlLnByaW50KFwiQ2FuIG5vdCB1c2UgXCIgKyB3aXRoSXRlbU5hbWUgKyBcIiB3aXRoIHRoaXMuXCIpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgY29uZGl0aW9uTWV0ID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoYWN0aW9uLmlmKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbi5pZi5mb3JFYWNoKGZ1bmN0aW9uIChjb25kaXRpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjb25kaXRpb25GdW5jID0gY29uZGl0aW9uc1tjb25kaXRpb24udHlwZV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29uZGl0aW9uRnVuYykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0YXJnZXRzID0gY29uZGl0aW9uLnRhcmdldHMgfHwgW2VudGl0eS5uYW1lXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25kaXRpb25NZXQgPSB0YXJnZXRzLmV2ZXJ5KGZ1bmN0aW9uICh0YXJnZXRJZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZW50aXR5ID0gZ2FtZVN0YXRlLmFsbEVudGl0aWVzW3RhcmdldElkXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGNvbmRpdGlvbkZ1bmMoZ2FtZVN0YXRlLCBjb25kaXRpb24sIGVudGl0eSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcmVzdWx0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYW1lU3RhdGUucHJpbnQoY29uZGl0aW9uLmVsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAoY29uZGl0aW9uTWV0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhY3Rpb24udGV4dCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZVN0YXRlLnByaW50KGFjdGlvbi50ZXh0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWN0aW9uLmRvKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb24uZG8uZm9yRWFjaChmdW5jdGlvbiAoZG9BY3Rpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYWN0aW9uRnVuYyA9IGFjdGlvbnNbZG9BY3Rpb24udHlwZV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGlvbkZ1bmMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRhcmdldHMgPSBkb0FjdGlvbi50YXJnZXRzIHx8IFtlbnRpdHkubmFtZV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldHMuZm9yRWFjaChmdW5jdGlvbiAodGFyZ2V0SWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlbnRpdHkgPSBnYW1lU3RhdGUuYWxsRW50aXRpZXNbdGFyZ2V0SWRdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uRnVuYyhnYW1lU3RhdGUsIGRvQWN0aW9uLCBlbnRpdHkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1dKTtcclxuXHJcbm1vZHVsZS5mYWN0b3J5KFwiR29Db21tYW5kXCIsIFtmdW5jdGlvbiAoKSB7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKGdhbWVTdGF0ZSwgY21kLCBjbWRLZXksIHBhcmFtKSB7XHJcbiAgICAgICAgdmFyIGxvY2F0aW9uTmFtZSA9IHBhcmFtO1xyXG4gICAgICAgIGlmICghbG9jYXRpb25OYW1lKSB7XHJcbiAgICAgICAgICAgIGdhbWVTdGF0ZS5wcmludChcIldoZXJlIHRvIGdvIHRvP1wiKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB2YXIgbG9jYXRpb24gPSBnYW1lU3RhdGUuYWxsRW50aXRpZXNbbG9jYXRpb25OYW1lXTtcclxuICAgICAgICAgICAgaWYgKCFsb2NhdGlvbiB8fCAhbG9jYXRpb24udmlzaWJsZSkge1xyXG4gICAgICAgICAgICAgICAgZ2FtZVN0YXRlLnByaW50KGxvY2F0aW9uTmFtZSArIFwiIG5vdCBmb3VuZC4gQ2FuIG5vdCBnby5cIik7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAobG9jYXRpb24gPT09IGdhbWVTdGF0ZS5sb2NhdGlvbikge1xyXG4gICAgICAgICAgICAgICAgZ2FtZVN0YXRlLnByaW50KFwiWW91IGFyZSBhbHJlYWR5IGF0IFwiICsgbG9jYXRpb25OYW1lKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmICghbG9jYXRpb24uZW5hYmxlZCB8fCBnYW1lU3RhdGUubG9jYXRpb24uYWRqYWNlbnQuaW5kZXhPZihsb2NhdGlvbi5uYW1lKSA8IDApIHtcclxuICAgICAgICAgICAgICAgIGdhbWVTdGF0ZS5wcmludChcIkNhbiBub3QgZ28gdG8gXCIgKyBsb2NhdGlvbi5uYW1lKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGdhbWVTdGF0ZS5sb2NhdGlvbiA9IGxvY2F0aW9uO1xyXG4gICAgICAgICAgICAgICAgZ2FtZVN0YXRlLnByaW50KFwiWW91IGFyZSBub3cgYXQ6IFwiICsgbG9jYXRpb24ubmFtZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1dKTtcclxuXHJcbm1vZHVsZS5mYWN0b3J5KFwiSGVscENvbW1hbmRcIiwgW2Z1bmN0aW9uICgpIHtcclxuICAgIGZ1bmN0aW9uIGhlbHBDbWQoZ2FtZVN0YXRlLCBjbWQsIGNtZEtleSwgcGFyYW0pIHtcclxuICAgICAgICBnYW1lU3RhdGUucHJpbnQoXCJBdmFpbGFibGUgY29tbWFuZHM6IFwiICsgaGVscENtZC5pbnRlcmFjdGlvbnMubWFwKGZ1bmN0aW9uIChpbnRlcmFjdGlvbikge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGludGVyYWN0aW9uLmNtZHNbMF07XHJcbiAgICAgICAgICAgIH0pLmpvaW4oXCIsIFwiKSArIFwiLlwiKTtcclxuICAgIH1cclxuXHJcbiAgICAvL2NhbiBub3QgaGF2ZSBkZXBlbmRlbmN5IHRvIEludGVyYWN0aW9ucywgd291bGQgYmUgYSBjeWNsaWMgZGVwZW5kZW5jeVxyXG4gICAgLy93aWxsIGJlIHNldCBsYXRlciBpbiBJbnRlcmFjdGlvbiBmYWN0b3J5XHJcbiAgICBoZWxwQ21kLmludGVyYWN0aW9ucyA9IFtdO1xyXG4gICAgcmV0dXJuIGhlbHBDbWQ7XHJcbn1dKTtcclxuXHJcbm1vZHVsZS5zZXJ2aWNlKFwiSW50ZXJhY3Rpb25cIiwgW2Z1bmN0aW9uICgpIHtcclxuICAgIHJldHVybiBmdW5jdGlvbiAoY21kcywgY21kS2V5LCBjb21tYW5kKSB7XHJcbiAgICAgICAgdGhpcy5jbWRzID0gY21kcztcclxuICAgICAgICB0aGlzLmRvID0gZnVuY3Rpb24gKGdhbWVTdGF0ZSwgY21kLCBwYXJhbSkge1xyXG4gICAgICAgICAgICBjb21tYW5kKGdhbWVTdGF0ZSwgY21kLCBjbWRLZXksIHBhcmFtKTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG59XSk7XHJcblxyXG5tb2R1bGUuZmFjdG9yeShcIkludGVyYWN0aW9uc1wiLCBbXCJJbnRlcmFjdGlvblwiLCBcIkVudGl0eUNvbW1hbmRcIiwgXCJHb0NvbW1hbmRcIiwgXCJIZWxwQ29tbWFuZFwiLFxyXG4gICAgZnVuY3Rpb24gKEludGVyYWN0aW9uLCBFbnRpdHlDb21tYW5kLCBHb0NvbW1hbmQsIEhlbHBDb21tYW5kKSB7XHJcbiAgICAgICAgdmFyIGludGVyYWN0aW9ucyA9IFtcclxuICAgICAgICAgICAgbmV3IEludGVyYWN0aW9uKFtcInVzZVwiXSwgXCJ1c2VcIiwgRW50aXR5Q29tbWFuZCksXHJcbiAgICAgICAgICAgIG5ldyBJbnRlcmFjdGlvbihbXCJ0YWtlXCIsIFwicGljayB1cFwiXSwgXCJ0YWtlXCIsIEVudGl0eUNvbW1hbmQpLFxyXG4gICAgICAgICAgICBuZXcgSW50ZXJhY3Rpb24oW1wibG9vayBhdFwiLCBcImxvb2tcIiwgXCJpbnNwZWN0XCJdLCBcImxvb2tcIiwgRW50aXR5Q29tbWFuZCksXHJcbiAgICAgICAgICAgIG5ldyBJbnRlcmFjdGlvbihbXCJnbyB0b1wiLCBcIndhbGsgdG9cIiwgXCJnb1wiLCBcIndhbGtcIiwgXCJjZFwiXSwgXCJnb1wiLCBHb0NvbW1hbmQpLFxyXG4gICAgICAgICAgICBuZXcgSW50ZXJhY3Rpb24oW1wiaGVscFwiLCBcIj9cIl0sIFwiXCIsIEhlbHBDb21tYW5kKVxyXG4gICAgICAgIF07XHJcblxyXG4gICAgICAgIEhlbHBDb21tYW5kLmludGVyYWN0aW9ucyA9IGludGVyYWN0aW9ucztcclxuXHJcbiAgICAgICAgaW50ZXJhY3Rpb25zLmZvckNtZCA9IGZ1bmN0aW9uIChjbWQpIHtcclxuICAgICAgICAgICAgdmFyIHVzZWRDbWQgPSBcIlwiO1xyXG4gICAgICAgICAgICB2YXIgbWF0Y2hlcyA9ICQuZ3JlcChpbnRlcmFjdGlvbnMsIGZ1bmN0aW9uIChpbnRlcmFjdGlvbikge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGludGVyYWN0aW9uLmNtZHMuc29tZShmdW5jdGlvbiAoaUNtZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjbWQuc3Vic3RyKDAsIGlDbWQubGVuZ3RoKSA9PT0gaUNtZCAmJlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAoY21kLmxlbmd0aCA9PSBpQ21kLmxlbmd0aCB8fCBjbWRbaUNtZC5sZW5ndGhdID09IFwiIFwiKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB1c2VkQ21kID0gaUNtZDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdmFyIGludGVyYWN0aW9uID0gbWF0Y2hlcy5sZW5ndGggPiAwID8gbWF0Y2hlc1swXSA6IG51bGw7XHJcbiAgICAgICAgICAgIHZhciBwYXJhbSA9IGNtZC5zdWJzdHIodXNlZENtZC5sZW5ndGgpLnRyaW0oKTtcclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIGRvOiBmdW5jdGlvbiAoZ2FtZVN0YXRlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGludGVyYWN0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGludGVyYWN0aW9uLmRvKGdhbWVTdGF0ZSwgdXNlZENtZCwgcGFyYW0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcztcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBlbHNlOiBmdW5jdGlvbiAoY2FsbGJhY2spIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIWludGVyYWN0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGludGVyYWN0aW9ucztcclxuICAgIH1dKTtcclxuXHJcbm1vZHVsZS5zZXJ2aWNlKFwiRW50aXR5XCIsIFtcImdldE9yRGVmYXVsdFwiLCBmdW5jdGlvbiAoZ2V0T3JEZWZhdWx0KSB7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKG5hbWUsIG1vZGVsLCBwYXJlbnQpIHtcclxuICAgICAgICB0aGlzLm5hbWUgPSBuYW1lO1xyXG4gICAgICAgIHRoaXMucGFyZW50ID0gcGFyZW50O1xyXG5cclxuICAgICAgICB0aGlzLnRleHQgPSBtb2RlbC50ZXh0O1xyXG4gICAgICAgIHRoaXMuaW1hZ2VVcmwgPSBtb2RlbC5pbWFnZVVybDtcclxuXHJcbiAgICAgICAgdGhpcy52aXNpYmxlID0gZ2V0T3JEZWZhdWx0KG1vZGVsLnZpc2libGUsIHRydWUpO1xyXG4gICAgICAgIHRoaXMuZW5hYmxlZCA9IGdldE9yRGVmYXVsdChtb2RlbC5lbmFibGVkLCB0cnVlKTtcclxuXHJcbiAgICAgICAgdGhpcy5zdGF0ZSA9IG1vZGVsLnN0YXRlIHx8IFwiXCI7XHJcblxyXG4gICAgICAgIHRoaXMudXNlID0gbW9kZWwudXNlIHx8IG51bGw7XHJcbiAgICAgICAgdGhpcy51c2Vfd2l0aCA9IG1vZGVsLnVzZV93aXRoIHx8IG51bGw7XHJcbiAgICAgICAgdGhpcy50YWtlID0gbW9kZWwudGFrZSB8fCBudWxsO1xyXG4gICAgICAgIHRoaXMubG9vayA9IG1vZGVsLmxvb2sgfHwgbnVsbDtcclxuXHJcbiAgICAgICAgdGhpcy5vYmplY3RzID0gbW9kZWwub2JqZWN0cyB8fCB7fTtcclxuXHJcbiAgICAgICAgLy9mb3IgbG9jYXRpb25zXHJcbiAgICAgICAgdGhpcy5hZGphY2VudCA9IG1vZGVsLmFkamFjZW50IHx8IFtdO1xyXG5cclxuICAgICAgICB0aGlzLnJlbW92ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMucGFyZW50ICYmIHRoaXMubmFtZSBpbiB0aGlzLnBhcmVudC5vYmplY3RzKSB7XHJcbiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5wYXJlbnQub2JqZWN0c1t0aGlzLm5hbWVdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdGhpcy5hZGQgPSBmdW5jdGlvbiAoZW50aXR5KSB7XHJcbiAgICAgICAgICAgIHRoaXMub2JqZWN0c1tlbnRpdHkubmFtZV0gPSBlbnRpdHk7XHJcbiAgICAgICAgICAgIGVudGl0eS5wYXJlbnQgPSB0aGlzO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufV0pO1xyXG5cclxubW9kdWxlLmZhY3RvcnkoXCJidWlsZEVudGl0eU1hcFwiLCBbXCJFbnRpdHlcIiwgZnVuY3Rpb24gKEVudGl0eSkge1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChtb2RlbCkge1xyXG4gICAgICAgIHZhciBhbGxFbnRpdGllcyA9IHt9O1xyXG4gICAgICAgIGZvciAodmFyIGtleSBpbiBtb2RlbC5sb2NhdGlvbnMpIHtcclxuICAgICAgICAgICAgdmFyIGxvYyA9IG1vZGVsLmxvY2F0aW9uc1trZXldO1xyXG4gICAgICAgICAgICB2YXIgbG9jRW50aXR5ID0gbmV3IEVudGl0eShrZXksIGxvYywgbnVsbCk7XHJcbiAgICAgICAgICAgIGFsbEVudGl0aWVzW2tleV0gPSBsb2NFbnRpdHk7XHJcblxyXG4gICAgICAgICAgICBmb3IgKHZhciBvYmpLZXkgaW4gbG9jLm9iamVjdHMpIHtcclxuICAgICAgICAgICAgICAgIGFsbEVudGl0aWVzW29iaktleV0gPSBuZXcgRW50aXR5KG9iaktleSwgbG9jLm9iamVjdHNbb2JqS2V5XSwgbG9jRW50aXR5KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBPYmplY3Qua2V5cyhhbGxFbnRpdGllcykuZm9yRWFjaChmdW5jdGlvbiAobmFtZSkge1xyXG4gICAgICAgICAgICB2YXIgZW50aXR5ID0gYWxsRW50aXRpZXNbbmFtZV07XHJcbiAgICAgICAgICAgIHZhciBvYmplY3RNb2RlbCA9IGVudGl0eS5vYmplY3RzO1xyXG4gICAgICAgICAgICBlbnRpdHkub2JqZWN0cyA9IHt9O1xyXG4gICAgICAgICAgICBPYmplY3Qua2V5cyhvYmplY3RNb2RlbCkuZm9yRWFjaChmdW5jdGlvbiAob2JqTmFtZSkge1xyXG4gICAgICAgICAgICAgICAgZW50aXR5Lm9iamVjdHNbb2JqTmFtZV0gPSBhbGxFbnRpdGllc1tvYmpOYW1lXTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIGFsbEVudGl0aWVzO1xyXG4gICAgfVxyXG59XSk7XHJcblxyXG5tb2R1bGUuc2VydmljZShcIkdhbWVTdGF0ZVwiLCBbXCJidWlsZEVudGl0eU1hcFwiLCBcIkVudGl0eVwiLCBcIkludGVyYWN0aW9uc1wiLCBcIlByZWRpY3Rpb25TZXJ2aWNlXCIsXHJcbiAgICBmdW5jdGlvbiAoYnVpbGRFbnRpdHlNYXAsIEVudGl0eSwgaW50ZXJhY3Rpb25zLCBwcmVkaWN0aW9uU2VydmljZSkge1xyXG4gICAgICAgIHJldHVybiBmdW5jdGlvbiAoZ2FtZSwgcHJpbnRlciwgd2luQ2FsbGJhY2spIHtcclxuICAgICAgICAgICAgdmFyIGdhbWVTdGF0ZSA9IHRoaXM7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmdhbWUgPSBnYW1lO1xyXG4gICAgICAgICAgICB0aGlzLnByaW50ID0gcHJpbnRlcjtcclxuICAgICAgICAgICAgdGhpcy5wcmVkaWN0aW9uU2VydmljZSA9IHByZWRpY3Rpb25TZXJ2aWNlO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5hbGxFbnRpdGllcyA9IGJ1aWxkRW50aXR5TWFwKGdhbWUubW9kZWwpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5sb2NhdGlvbiA9IHRoaXMuYWxsRW50aXRpZXNbZ2FtZS5zdGFydExvY2F0aW9uTmFtZV07XHJcblxyXG4gICAgICAgICAgICB0aGlzLmludmVudG9yeSA9IG5ldyBFbnRpdHkoXCJpbnZlbnRvcnlcIiwge30sIG51bGwpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5wcmludChnYW1lLnN0YXJ0VGV4dCk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLndpbiA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucHJpbnQoXCJZT1UgV0lOIFRIRSBHQU1FXCIpO1xyXG4gICAgICAgICAgICAgICAgd2luQ2FsbGJhY2soKTtcclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIC8vY3JlYXRlIGZsYXR0ZW5lZCBsaXN0IG9mIGFsbCBwb3NzaWJsZSBjb21tYW5kcywgZm9yIHRoZSBwcmVkaWN0aW9uIHNlcnZpY2VcclxuICAgICAgICAgICAgdGhpcy5jb21tYW5kTGlzdCA9IFtdO1xyXG4gICAgICAgICAgICBpbnRlcmFjdGlvbnMuZm9yRWFjaChmdW5jdGlvbiAoaW50ZXJhY3Rpb24pIHtcclxuICAgICAgICAgICAgICAgIGdhbWVTdGF0ZS5jb21tYW5kTGlzdC5wdXNoLmFwcGx5KGdhbWVTdGF0ZS5jb21tYW5kTGlzdCwgaW50ZXJhY3Rpb24uY21kcyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB0aGlzLmVudGVyID0gZnVuY3Rpb24gKHRleHQpIHtcclxuICAgICAgICAgICAgICAgIHZhciB0cmltbWVkVGV4dCA9IHRleHQudHJpbSgpO1xyXG4gICAgICAgICAgICAgICAgaW50ZXJhY3Rpb25zLmZvckNtZCh0cmltbWVkVGV4dClcclxuICAgICAgICAgICAgICAgICAgICAuZG8odGhpcylcclxuICAgICAgICAgICAgICAgICAgICAuZWxzZShmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcmVkaWN0aW9uID0gcHJlZGljdGlvblNlcnZpY2UuZmluZENsb3Nlc3RFbGVtZW50KHRyaW1tZWRUZXh0LCBnYW1lU3RhdGUuY29tbWFuZExpc3QpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJlZGljdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FtZVN0YXRlLnByaW50KFwiRGlkIHlvdSBtZWFuIFwiICsgcHJlZGljdGlvbiArIFwiP1wiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhbWVTdGF0ZS5wcmludChcIkkgZG9uJ3QgdW5kZXJzdGFuZCAnXCIgKyB0cmltbWVkVGV4dCArIFwiJy5cIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1dKTtcclxuXHJcbm1vZHVsZS5zZXJ2aWNlKFwiR2FtZVwiLCBbXCJHYW1lU3RhdGVcIiwgZnVuY3Rpb24gKEdhbWVTdGF0ZSkge1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIChtb2RlbCkge1xyXG4gICAgICAgIHRoaXMuc3RhcnRMb2NhdGlvbk5hbWUgPSBtb2RlbC5zdGFydDtcclxuICAgICAgICB0aGlzLnN0YXJ0VGV4dCA9IG1vZGVsLnN0YXJ0X3RleHQ7XHJcbiAgICAgICAgdGhpcy5tb2RlbCA9IG1vZGVsO1xyXG5cclxuICAgICAgICB0aGlzLnN0YXJ0ID0gZnVuY3Rpb24gKHByaW50ZXIsIHdpbkNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgR2FtZVN0YXRlKHRoaXMsIHByaW50ZXIsIHdpbkNhbGxiYWNrKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1dKTtcclxuIiwiXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG52YXIgcHJlZGljdGlvbiA9IGFuZ3VsYXIubW9kdWxlKFwianN0ZXh0LnByZWRpY3Rpb25cIiwgW10pO1xyXG5wcmVkaWN0aW9uLmNvbnN0YW50KFwiSEFNTUlOR19USFJFU0hPTERcIiwgNCk7XHJcblxyXG5wcmVkaWN0aW9uLmZhY3RvcnkoXCJQcmVkaWN0aW9uU2VydmljZVwiLCBbXCJIQU1NSU5HX1RIUkVTSE9MRFwiLCBmdW5jdGlvbihIQU1NSU5HX1RIUkVTSE9MRCkge1xyXG4gICAgdmFyIHNlcnZpY2UgPSB7fTtcclxuICAgIHNlcnZpY2UuZmluZENsb3Nlc3RFbGVtZW50ID0gZnVuY3Rpb24gZmluZENsb3Nlc3RFbGVtZW50IChlbGVtZW50LCBoYXlzdGFjaykge1xyXG4gICAgICAgIHRoaXMuZmluZEhhbW1pbmdEaXN0YW5jZSA9IGZ1bmN0aW9uIGZpbmRIYW1taW5nRGlzdGFuY2UoYSwgYikge1xyXG4gICAgICAgICAgICB2YXIgZmlyc3RJc1Nob3J0ZXIgPSBhLmxlbmd0aCA8PSBiLmxlbmd0aDtcclxuICAgICAgICAgICAgdmFyIHNob3J0ZXIgPSAoZmlyc3RJc1Nob3J0ZXIgPyBhIDogYikudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICAgICAgdmFyIGxvbmdlciA9ICghZmlyc3RJc1Nob3J0ZXIgPyBhIDogYikudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICAgICAgdmFyIGhhbW1pbmdEaXN0YW5jZSA9IDA7XHJcblxyXG4gICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgbG9uZ2VyLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBQYWQgU3RyaW5nIHNvIGJvdGggaGF2ZSB0aGUgc2FtZSBsZW5ndGgsIHVzZSAwIHNvIHRoZSBoYW1taW5nIGRpc3RhbmNlIGluY3JlYXNlcyBmb3IgZWFjaCBhZGRpdGlvbmFsIGNoYXJhY3RlclxyXG4gICAgICAgICAgICAgICAgaWYoc2hvcnRlci5sZW5ndGggPT09IGkpIHsgc2hvcnRlciA9IHNob3J0ZXIgKyAnICc7IH1cclxuICAgICAgICAgICAgICAgIGlmIChzaG9ydGVyLmNoYXJBdChpKSAhPT0gbG9uZ2VyLmNoYXJBdChpKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGhhbW1pbmdEaXN0YW5jZSArPSAxO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gaGFtbWluZ0Rpc3RhbmNlO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHZhciBtaW5EaXN0YW5jZSA9IE51bWJlci5NQVhfVkFMVUU7XHJcbiAgICAgICAgdmFyIGNsb3Nlc3RFbGVtZW50ID0gbnVsbDtcclxuICAgICAgICB2YXIgZm91bmRFbGU7XHJcbiAgICAgICAgZm9yICh2YXIgaSBpbiBoYXlzdGFjaykge1xyXG4gICAgICAgICAgICB2YXIgdGVzdCA9IGhheXN0YWNrW2ldO1xyXG4gICAgICAgICAgICBpZih0ZXN0Lmxlbmd0aCA8IDIpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHZhciBjdXJyZW50RWxlID0gZWxlbWVudDtcclxuICAgICAgICAgICAgaWYoY3VycmVudEVsZS5sZW5ndGggPiB0ZXN0Lmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgY3VycmVudEVsZSA9IGN1cnJlbnRFbGUuc3Vic3RyKDAsIHRlc3QubGVuZ3RoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB2YXIgY3VycmVudERpc3RhbmNlID0gdGhpcy5maW5kSGFtbWluZ0Rpc3RhbmNlKGN1cnJlbnRFbGUsIHRlc3QpO1xyXG4gICAgICAgICAgICBpZiAoY3VycmVudERpc3RhbmNlIDwgbWluRGlzdGFuY2UpIHtcclxuICAgICAgICAgICAgICAgIG1pbkRpc3RhbmNlID0gY3VycmVudERpc3RhbmNlO1xyXG4gICAgICAgICAgICAgICAgY2xvc2VzdEVsZW1lbnQgPSB0ZXN0O1xyXG4gICAgICAgICAgICAgICAgZm91bmRFbGUgPSBjdXJyZW50RWxlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBJZiB0aGUgZGlzdGFuY2UgaXMgZ3JlYXRlciB0aGFuIHRoZSB0aHJlc2hvbGQsIHRoZSBjbG9zZXN0IGVsZW1lbnQgaXMgdG9vIGRpZmZlcmVudFxyXG4gICAgICAgIC8vIGxpbWl0IHRocmVzaG9sZCB0byBsZW5ndGggb2YgaW5wdXQgLSAxLCB0byBhdm9pZCBmaW5kaW5nIGNvbXBsZXRlbHkgZGlmZmVyZW50IHN0cmluZ3NcclxuICAgICAgICB2YXIgdGhyZXNob2xkID0gTWF0aC5taW4oSEFNTUlOR19USFJFU0hPTEQsIGZvdW5kRWxlLmxlbmd0aCAtIDEpO1xyXG4gICAgICAgIHJldHVybiBtaW5EaXN0YW5jZSA8PSB0aHJlc2hvbGQgPyBjbG9zZXN0RWxlbWVudCA6IG51bGw7XHJcbiAgICB9O1xyXG5cclxuICAgIHJldHVybiBzZXJ2aWNlO1xyXG59XSk7Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9