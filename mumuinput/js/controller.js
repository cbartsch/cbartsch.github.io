"use strict";define(["utils","constants"],function(n,t){return function(){function e(){if(u.orientation=n.getOrientation(),!d.isInputDisabled()){var e=n.getOrientationData()>0?1:-1;window.DeviceMotionEvent?u.orientation===t.LANDSCAPE&&(u.axisScale=7.5*e):window.DeviceOrientationEvent?u.axisScale=80*e:u.axisScale=1}}function o(t){return n.clamp(t,-1,1)}function i(){d.onInput(u.controller)}function c(){var n={type:t.MESSAGE_TYPE_HELLO,id:u.id,name:u.name};d.sendMessage(JSON.stringify(n)),d.onConnect()}function a(e){var o=JSON.parse(e.data);o&&(o.type===t.MESSAGE_TYPE_HELLO?(u.handshake=!0,u.id=o.id,n.setCookie(t.USER_ID_COOKIE,u.id)):d.onMessage(o))}function s(n){d.onError(n)}function r(){d.onDisconnect()}var d=this,u={id:n.getCookie(t.USER_ID_COOKIE),name:void 0,connection:void 0,handshake:!1,orientation:n.getOrientation(),axisScale:1,actionCount:0,controller:{axis:0}};d.connect=function(n,t){u.connection||(u.connection=new WebSocket(n),u.name=t,u.connection.onopen=c,u.connection.onmessage=a,u.connection.onerror=s,u.connection.onclose=r)},d.sendInput=function(){d.isConnected()&&!d.isInputDisabled()&&u.connection.send(JSON.stringify(u.controller))},d.disconnect=function(){u.connection&&(u.connection.close(),u.connection=void 0,u.handshake=!1)},d.sendMessage=function(n){u.connection&&u.connection.readyState===WebSocket.OPEN&&u.connection.send(n)},d.getControllerData=function(){return u.controller},d.isInputDisabled=function(){return!u.handshake&&!(window.DeviceMotionEvent||u.orientation===t.LANDSCAPE)},d.getAxisMethod=function(){return window.DeviceMotionEvent?"DeviceMotion":window.DeviceOrientationEvent?"DeviceOrientationEvent":"MozOrientation/Nothing"},d.isConnected=function(){return u.connection&&u.connection.readyState===WebSocket.OPEN},d.addAction=function(n){function t(n){d.isInputDisabled()||(u.controller[a]=!0,i())}function e(n){d.isInputDisabled()||(u.controller[a]=!1,i())}function o(n){u.controller[a]=!1}var c=u.actionCount+1;u.actionCount=c;var a="action"+(c>1?c:"");u.controller[a]=!1,"ontouchstart"in window?(n.addEventListener("touchstart",t),n.addEventListener("touchend",e)):(n.addEventListener("mousedown",t),n.addEventListener("mouseup",e)),window.addEventListener("orientationchange",o)},d.setAxis=function(n){d.isInputDisabled()||(u.controller.axis=n,i())},this.onConnect=function(){},this.onMessage=function(n){},this.onError=function(n){},this.onDisconnect=function(){},this.onInput=function(n){},e(),window.DeviceMotionEvent?window.addEventListener("devicemotion",function(n){d.setAxis(o(n.accelerationIncludingGravity.y/u.axisScale))}):window.DeviceOrientationEvent?window.addEventListener("deviceorientation",function(n){d.setAxis(o(n.beta/u.axisScale))}):window.addEventListener("MozOrientation",function(n){d.setAxis(n.x)}),window.addEventListener("orientationchange",e)}});